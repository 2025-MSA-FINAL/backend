<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.popspot.popupplatform.mapper.manager.ManagerPageMapper">

    <select id="findProfileByUserId" resultType="com.popspot.popupplatform.dto.user.response.ManagerProfileResponse">
        SELECT
        user_id          AS userId,
        user_name        AS name,
        user_nickname    AS brandName,
        user_phonenumber AS phone,
        user_email       AS email,
        user_photo       AS profileImage,
        user_role        AS role
        FROM USER
        WHERE user_id = #{userId}
        AND user_status = 'ACTIVE'
    </select>

    <select id="findMyPopups" resultType="com.popspot.popupplatform.dto.popup.response.PopupListItemResponse">
        SELECT
        pop_id            AS popId,
        pop_name          AS popName,
        pop_thumbnail     AS popThumbnail,
        pop_location      AS popLocation,
        pop_start_date    AS popStartDate,
        pop_end_date      AS popEndDate,
        pop_status        AS popStatus,
        pop_price_type    AS popPriceType,
        pop_price         AS popPrice,
        pop_view_count    AS popViewCount
        FROM POPUPSTORE
        WHERE pop_owner_id = #{userId}
        AND pop_is_deleted = FALSE

        <if test="status != null and status != 'ALL'">
            AND pop_status = #{status}
        </if>

        ORDER BY
        <choose>
            <when test="sort == 'VIEW'">
                COALESCE(pop_view_count, 0) DESC,
                pop_id DESC
            </when>

            <when test="sort == 'DEADLINE'">
                CASE WHEN pop_status = 'ENDED' THEN 1 ELSE 0 END ASC,

                CASE WHEN pop_end_date IS NULL THEN 1 ELSE 0 END ASC,

                pop_end_date ASC,
                pop_id DESC
            </when>

            <when test="sort == 'CREATED'">
                created_at DESC,
                pop_id DESC
            </when>

            <when test="sort == 'POPULAR'">
                (
                IFNULL((
                SELECT COUNT(*)
                FROM POPUP_VIEWED v
                WHERE v.pop_id = POPUPSTORE.pop_id
                AND v.pv_viewed_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
                ), 0)
                +
                3 * IFNULL((
                SELECT COUNT(*)
                FROM USER_WISHLIST w
                WHERE w.pop_id = POPUPSTORE.pop_id
                ), 0)
                ) DESC,

                pop_id DESC
            </when>

            <otherwise>
                pop_id DESC
            </otherwise>
        </choose>

        , pop_id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countMyPopups" resultType="long">
        SELECT COUNT(*)
        FROM POPUPSTORE
        WHERE pop_owner_id = #{userId}
        AND pop_is_deleted = FALSE
        <if test="status != null and status != 'ALL'">
            AND pop_status = #{status}
        </if>
    </select>

</mapper>