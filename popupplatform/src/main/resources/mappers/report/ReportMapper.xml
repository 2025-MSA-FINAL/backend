<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.popspot.popupplatform.mapper.report.ReportMapper">

    <!-- 검색 조건 SQL 조각 -->
    <sql id="searchCondition">
        <if test="keyword != null and keyword != ''">
            AND (
            <choose>
                <when test='searchType != null and searchType.equals("reporterName")'>
                    u.user_name LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test='searchType != null and searchType.equals("reporterNickname")'>
                    u.user_nickname LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test='searchType != null and searchType.equals("targetName")'>
                    (
                    (r.rep_type = 'user' AND target_u.user_name LIKE CONCAT('%', #{keyword}, '%'))
                    OR (r.rep_type = 'chat' AND gcr.gcr_title LIKE CONCAT('%', #{keyword}, '%'))
                    )
                </when>
                <when test='searchType != null and searchType.equals("categoryName")'>
                    rc.rc_name LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <otherwise>
                    rc.rc_name LIKE CONCAT('%', #{keyword}, '%')
                    OR u.user_name LIKE CONCAT('%', #{keyword}, '%')
                    OR u.user_nickname LIKE CONCAT('%', #{keyword}, '%')
                    OR (r.rep_type = 'user' AND target_u.user_name LIKE CONCAT('%', #{keyword}, '%'))
                    OR (r.rep_type = 'user' AND target_u.user_nickname LIKE CONCAT('%', #{keyword}, '%'))
                    OR (r.rep_type = 'chat' AND gcr.gcr_title LIKE CONCAT('%', #{keyword}, '%'))
                </otherwise>
            </choose>
            )
        </if>
    </sql>

    <!-- ============================================ -->
    <!-- ResultMap 정의                              -->
    <!-- ============================================ -->

    <resultMap id="ReportListResultMap" type="com.popspot.popupplatform.dto.report.ReportListDTO">
        <id property="repId" column="rep_id"/>
        <result property="repType" column="rep_type"/>
        <result property="categoryName" column="category_name"/>
        <result property="reporterName" column="reporter_name"/>
        <result property="userNickname" column="user_nickname"/>
        <result property="createdAt" column="created_at"/>
        <result property="repStatus" column="rep_status"/>
        <result property="targetName" column="target_name"/>
        <result property="targetNickname" column="target_nickname"/>
    </resultMap>

    <resultMap id="ReportDetailResultMap" type="com.popspot.popupplatform.dto.report.ReportDetailDTO">
        <id property="repId" column="rep_id"/>
        <result property="repType" column="rep_type"/>
        <result property="repTargetId" column="rep_target_id"/>
        <result property="repStatus" column="rep_status"/>
        <result property="categoryName" column="category_name"/>
        <result property="userId" column="user_id"/>
        <result property="userNickname" column="user_nickname"/>
        <result property="userEmail" column="user_email"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- ============================================ -->
    <!-- 1. 전체 신고 목록 조회 (페이지네이션 없음)  -->
    <!-- ============================================ -->
    <select id="findAllReports" resultMap="ReportListResultMap">
        SELECT
        r.rep_id,
        r.rep_type,
        rc.rc_name AS category_name,
        u.user_name AS reporter_name,
        u.user_nickname,
        DATE_FORMAT(r.created_at, '%Y-%m-%d %H:%i:%s') AS created_at,
        r.rep_status,
        CASE
        WHEN r.rep_type = 'USER' THEN IFNULL(target_u.user_name, '알 수 없음')
        WHEN r.rep_type = 'CHAT' THEN IFNULL(gcr.gcr_title, '알 수 없음')
        ELSE NULL
        END AS target_name,
        CASE
        WHEN r.rep_type = 'USER' THEN target_u.user_nickname
        ELSE NULL
        END AS target_nickname
        FROM REPORT r
        INNER JOIN REPORT_CATEGORY rc ON r.rc_id = rc.rc_id
        INNER JOIN USER u ON r.user_id = u.user_id
        LEFT JOIN USER target_u ON r.rep_type = 'user' AND r.rep_target_id = target_u.user_id
        LEFT JOIN GROUP_CHAT_ROOM gcr ON r.rep_type = 'chat' AND r.rep_target_id = gcr.gcr_id
        ORDER BY r.created_at DESC
    </select>

    <!-- ============================================ -->
    <!-- 2. 신고 상세 조회                           -->
    <!-- ============================================ -->
    <select id="findReportById" resultMap="ReportDetailResultMap">
        SELECT
        r.rep_id,
        r.rep_type,
        r.rep_target_id,
        r.rep_status,
        rc.rc_name AS category_name,
        r.user_id,
        u.user_nickname,
        u.user_email,
        DATE_FORMAT(r.created_at, '%Y-%m-%d %H:%i:%s') AS created_at
        FROM REPORT r
        INNER JOIN REPORT_CATEGORY rc ON r.rc_id = rc.rc_id
        INNER JOIN USER u ON r.user_id = u.user_id
        WHERE r.rep_id = #{repId}
    </select>

    <!-- ============================================ -->
    <!-- 3. 신고 이미지 조회                         -->
    <!-- ============================================ -->
    <select id="findReportImages" resultType="String">
        SELECT '' AS image_url
        FROM REPORT
        WHERE rep_id = #{repId}
        LIMIT 0
    </select>

    <!-- ============================================ -->
    <!-- 4. 신고 상태 업데이트                       -->
    <!-- ============================================ -->
    <update id="updateReportStatus">
        UPDATE REPORT
        SET rep_status = #{status},
        updated_at = CURRENT_TIMESTAMP
        WHERE rep_id = #{repId}
    </update>

    <!-- ============================================ -->
    <!-- 5. 상태별 신고 수 조회 (3단계 로직)        -->
    <!-- ============================================ -->
    <select id="countByStatus" resultType="long">
        SELECT COUNT(*)
        FROM REPORT
        <where>
            <choose>
                <when test='status != null and status.equals("approved")'>
                    rep_status IN ('approved', 'resolved')
                </when>
                <otherwise>
                    rep_status = #{status}
                </otherwise>
            </choose>
        </where>
    </select>

    <!-- ============================================ -->
    <!-- 6. 전체 신고 목록 조회 (페이지네이션 + 카테고리 필터) -->
    <!-- ============================================ -->
    <select id="findAllReportsWithPagination" resultMap="ReportListResultMap">
        SELECT
        r.rep_id,
        r.rep_type,
        rc.rc_name AS category_name,
        u.user_name AS reporter_name,
        u.user_nickname,
        DATE_FORMAT(r.created_at, '%Y-%m-%d %H:%i:%s') AS created_at,
        r.rep_status,
        CASE
        WHEN r.rep_type = 'USER' THEN IFNULL(target_u.user_name, '알 수 없음')
        WHEN r.rep_type = 'CHAT' THEN IFNULL(gcr.gcr_title, '알 수 없음')
        ELSE NULL
        END AS target_name,
        CASE
        WHEN r.rep_type = 'USER' THEN target_u.user_nickname
        ELSE NULL
        END AS target_nickname
        FROM REPORT r
        INNER JOIN REPORT_CATEGORY rc ON r.rc_id = rc.rc_id
        INNER JOIN USER u ON r.user_id = u.user_id
        LEFT JOIN USER target_u ON r.rep_type = 'user' AND r.rep_target_id = target_u.user_id
        LEFT JOIN GROUP_CHAT_ROOM gcr ON r.rep_type = 'chat' AND r.rep_target_id = gcr.gcr_id
        <where>
            <if test="categoryId != null">
                r.rc_id = #{categoryId}
            </if>
        </where>
        ORDER BY
        <choose>
            <when test='pageRequest.sortBy != null and pageRequest.sortBy.equals("createdAt")'>
                r.created_at ${pageRequest.sortDir}
            </when>
            <when test='pageRequest.sortBy != null and pageRequest.sortBy.equals("repStatus")'>
                r.rep_status ${pageRequest.sortDir}
            </when>
            <otherwise>
                r.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{pageRequest.size} OFFSET #{pageRequest.offset}
    </select>

    <!-- ============================================ -->
    <!-- 7. 전체 신고 수 조회 (카테고리 필터)       -->
    <!-- ============================================ -->
    <select id="countAllReports" resultType="long">
        SELECT COUNT(*)
        FROM REPORT r
        <where>
            <if test="categoryId != null">
                r.rc_id = #{categoryId}
            </if>
        </where>
    </select>

    <!-- ============================================ -->
    <!-- 8. 상태별 신고 목록 조회 (3단계 로직 + 카테고리 필터) -->
    <!-- ============================================ -->
    <select id="findReportsByStatus" resultMap="ReportListResultMap">
        SELECT
        r.rep_id,
        r.rep_type,
        rc.rc_name AS category_name,
        u.user_name AS reporter_name,
        u.user_nickname,
        DATE_FORMAT(r.created_at, '%Y-%m-%d %H:%i:%s') AS created_at,
        r.rep_status,
        CASE
        WHEN r.rep_type = 'USER' THEN IFNULL(target_u.user_name, '알 수 없음')
        WHEN r.rep_type = 'CHAT' THEN IFNULL(gcr.gcr_title, '알 수 없음')
        ELSE NULL
        END AS target_name,
        CASE
        WHEN r.rep_type = 'USER' THEN target_u.user_nickname
        ELSE NULL
        END AS target_nickname
        FROM REPORT r
        INNER JOIN REPORT_CATEGORY rc ON r.rc_id = rc.rc_id
        INNER JOIN USER u ON r.user_id = u.user_id
        LEFT JOIN USER target_u ON r.rep_type = 'user' AND r.rep_target_id = target_u.user_id
        LEFT JOIN GROUP_CHAT_ROOM gcr ON r.rep_type = 'chat' AND r.rep_target_id = gcr.gcr_id
        <where>
            <choose>
                <when test='status != null and status.equals("approved")'>
                    r.rep_status IN ('approved', 'resolved')
                </when>
                <otherwise>
                    r.rep_status = #{status}
                </otherwise>
            </choose>
            <if test="categoryId != null">
                AND r.rc_id = #{categoryId}
            </if>
        </where>
        ORDER BY
        <choose>
            <when test='pageRequest.sortBy != null and pageRequest.sortBy.equals("createdAt")'>
                r.created_at ${pageRequest.sortDir}
            </when>
            <when test='pageRequest.sortBy != null and pageRequest.sortBy.equals("repStatus")'>
                r.rep_status ${pageRequest.sortDir}
            </when>
            <otherwise>
                r.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{pageRequest.size} OFFSET #{pageRequest.offset}
    </select>

    <!-- ============================================ -->
    <!-- 9. 상태별 신고 수 조회 (3단계 로직 + 카테고리 필터) -->
    <!-- ============================================ -->
    <select id="countReportsByStatus" resultType="long">
        SELECT COUNT(*)
        FROM REPORT r
        <where>
            <choose>
                <when test='status != null and status.equals("approved")'>
                    r.rep_status IN ('approved', 'resolved')
                </when>
                <otherwise>
                    r.rep_status = #{status}
                </otherwise>
            </choose>
            <if test="categoryId != null">
                AND r.rc_id = #{categoryId}
            </if>
        </where>
    </select>

    <!-- ============================================ -->
    <!-- 10. 키워드 검색 (searchType 추가 + 3단계 로직 + 카테고리 필터) -->
    <!-- ============================================ -->
    <select id="searchReports" resultMap="ReportListResultMap">
        SELECT
        r.rep_id,
        r.rep_type,
        rc.rc_name AS category_name,
        u.user_name AS reporter_name,
        u.user_nickname,
        DATE_FORMAT(r.created_at, '%Y-%m-%d %H:%i:%s') AS created_at,
        r.rep_status,
        CASE
        WHEN r.rep_type = 'USER' THEN IFNULL(target_u.user_name, '알 수 없음')
        WHEN r.rep_type = 'CHAT' THEN IFNULL(gcr.gcr_title, '알 수 없음')
        ELSE NULL
        END AS target_name,
        CASE
        WHEN r.rep_type = 'USER' THEN target_u.user_nickname
        ELSE NULL
        END AS target_nickname
        FROM REPORT r
        INNER JOIN REPORT_CATEGORY rc ON r.rc_id = rc.rc_id
        INNER JOIN USER u ON r.user_id = u.user_id
        LEFT JOIN USER target_u ON r.rep_type = 'user' AND r.rep_target_id = target_u.user_id
        LEFT JOIN GROUP_CHAT_ROOM gcr ON r.rep_type = 'chat' AND r.rep_target_id = gcr.gcr_id
        <where>
            <if test="status != null and status != ''">
                <choose>
                    <when test='status.equals("approved")'>
                        r.rep_status IN ('approved', 'resolved')
                    </when>
                    <otherwise>
                        r.rep_status = #{status}
                    </otherwise>
                </choose>
            </if>
            <if test="categoryId != null">
                AND r.rc_id = #{categoryId}
            </if>
            <include refid="searchCondition"/>
        </where>
        ORDER BY
        <choose>
            <when test='pageRequest.sortBy != null and pageRequest.sortBy.equals("createdAt")'>
                r.created_at ${pageRequest.sortDir}
            </when>
            <when test='pageRequest.sortBy != null and pageRequest.sortBy.equals("repStatus")'>
                r.rep_status ${pageRequest.sortDir}
            </when>
            <otherwise>
                r.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{pageRequest.size} OFFSET #{pageRequest.offset}
    </select>

    <!-- ============================================ -->
    <!-- 11. 키워드 검색 결과 수 조회 (searchType 추가 + 3단계 로직 + 카테고리 필터) -->
    <!-- ============================================ -->
    <select id="countSearchReports" resultType="long">
        SELECT COUNT(*)
        FROM REPORT r
        INNER JOIN REPORT_CATEGORY rc ON r.rc_id = rc.rc_id
        INNER JOIN USER u ON r.user_id = u.user_id
        LEFT JOIN USER target_u ON r.rep_type = 'user' AND r.rep_target_id = target_u.user_id
        LEFT JOIN GROUP_CHAT_ROOM gcr ON r.rep_type = 'chat' AND r.rep_target_id = gcr.gcr_id
        <where>
            <if test="status != null and status != ''">
                <choose>
                    <when test='status.equals("approved")'>
                        r.rep_status IN ('approved', 'resolved')
                    </when>
                    <otherwise>
                        r.rep_status = #{status}
                    </otherwise>
                </choose>
            </if>
            <if test="categoryId != null">
                AND r.rc_id = #{categoryId}
            </if>
            <include refid="searchCondition"/>
        </where>
    </select>
    <!--신고생성-->
    <insert id="insertReport"
            parameterType="com.popspot.popupplatform.dto.chat.request.ChatReportRequest"
            useGeneratedKeys="true"
            keyProperty="repId">
        INSERT INTO REPORT (
        rep_type,
        rep_target_id,
        rc_id,
        user_id,
        rep_status,
        created_at
        ) VALUES (
        #{reportType},
        #{targetId},
        #{categoryId},
        #{userId},
        'pending',
        CURRENT_TIMESTAMP
        )
    </insert>
    <!--신고이미지생성-->
    <insert id="insertReportImage">
        INSERT INTO REPORT_IMAGE (
        rep_id,
        image_url,
        created_at
        ) VALUES (
        #{repId},
        #{imageUrl},
        CURRENT_TIMESTAMP
        )
    </insert>
    <!--중복 신고 여부 확인(신고상태대기일경우에만.. 완료일경우는 재신고 가능)-->
    <select id="existsPendingReport" resultType="boolean">
        SELECT EXISTS (
        SELECT 1
        FROM REPORT
        WHERE user_id = #{userId}
        AND rep_type = #{reportType}
        AND rep_target_id = #{targetId}
        AND rep_status = 'pending'
        )
    </select>
</mapper>