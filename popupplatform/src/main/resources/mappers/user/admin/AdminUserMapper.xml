<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.popspot.popupplatform.mapper.admin.AdminUserMapper">

    <resultMap id="UserListResultMap" type="com.popspot.popupplatform.dto.admin.UserListDTO">
        <id property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="userNickname" column="user_nickname"/>
        <result property="userEmail" column="user_email"/>
        <result property="userPhonenumber" column="user_phonenumber"/>
        <result property="userGender" column="user_gender"/>
        <result property="userBirthyear" column="user_birthyear"/>
        <result property="userStatus" column="user_status"/>
        <result property="userRole" column="user_role"/>
        <result property="userPhoto" column="user_photo"/>
        <result property="createdAt" column="created_at"/>
        <result property="oauthProvider" column="oauth_provider"/>
        <result property="oauthId" column="oauth_id"/>
        <result property="loginId" column="login_id"/>
        <result property="reservationCount" column="reservation_count"/>
        <result property="wishlistCount" column="wishlist_count"/>
        <result property="reportCount" column="report_count"/>
    </resultMap>

    <!-- 일반 유저 목록 조회 -->
    <select id="findUserList" resultMap="UserListResultMap">
        SELECT
        u.user_id,
        u.user_name,
        u.user_nickname,
        u.user_email,
        u.user_phonenumber,
        u.user_gender,
        u.user_birthyear,
        u.user_status,
        u.user_role,
        u.user_photo,
        u.created_at,
        us.oauth_provider,
        us.oauth_id,
        ug.login_id,
        (SELECT COUNT(*) FROM USER_RESERVATION ur WHERE ur.user_id = u.user_id) as reservation_count,
        (SELECT COUNT(*) FROM USER_WISHLIST uw WHERE uw.user_id = u.user_id) as wishlist_count,
        (SELECT COUNT(*) FROM REPORT r WHERE r.user_id = u.user_id) as report_count
        FROM USER u
        LEFT JOIN USER_SOCIAL us ON u.user_id = us.user_id
        LEFT JOIN USER_GENERAL ug ON u.user_id = ug.user_id
        WHERE u.user_role = 'user'
        AND u.user_status != 'deleted'
        ORDER BY
        <choose>
            <when test="sortBy == 'userName'">u.user_name</when>
            <when test="sortBy == 'userEmail'">u.user_email</when>
            <when test="sortBy == 'userStatus'">u.user_status</when>
            <otherwise>u.created_at</otherwise>
        </choose>
        ${sortDir}
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countUserList" resultType="long">
        SELECT COUNT(*) FROM USER
        WHERE user_role = 'user'
        AND user_status != 'deleted'
    </select>

    <!-- 매니저 목록 조회 -->
    <select id="findManagerList" resultMap="UserListResultMap">
        SELECT
        u.user_id,
        u.user_name,
        u.user_nickname,
        u.user_email,
        u.user_phonenumber,
        u.user_gender,
        u.user_birthyear,
        u.user_status,
        u.user_role,
        u.user_photo,
        u.created_at,
        us.oauth_provider,
        us.oauth_id,
        ug.login_id,
        (SELECT COUNT(*) FROM USER_RESERVATION ur WHERE ur.user_id = u.user_id) as reservation_count,
        (SELECT COUNT(*) FROM USER_WISHLIST uw WHERE uw.user_id = u.user_id) as wishlist_count,
        (SELECT COUNT(*) FROM REPORT r WHERE r.user_id = u.user_id) as report_count
        FROM USER u
        LEFT JOIN USER_SOCIAL us ON u.user_id = us.user_id
        LEFT JOIN USER_GENERAL ug ON u.user_id = ug.user_id
        WHERE u.user_role = 'manager'
        AND u.user_status != 'deleted'
        ORDER BY
        <choose>
            <when test="sortBy == 'userName'">u.user_name</when>
            <when test="sortBy == 'userEmail'">u.user_email</when>
            <when test="sortBy == 'userStatus'">u.user_status</when>
            <otherwise>u.created_at</otherwise>
        </choose>
        ${sortDir}
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countManagerList" resultType="long">
        SELECT COUNT(*) FROM USER
        WHERE user_role = 'manager'
        AND user_status != 'deleted'
    </select>

    <!-- 유저 상세 조회 -->
    <select id="findUserById" resultMap="UserListResultMap">
        SELECT
        u.user_id,
        u.user_name,
        u.user_nickname,
        u.user_email,
        u.user_phonenumber,
        u.user_gender,
        u.user_birthyear,
        u.user_status,
        u.user_role,
        u.user_photo,
        u.created_at,
        us.oauth_provider,
        us.oauth_id,
        ug.login_id,
        (SELECT COUNT(*) FROM USER_RESERVATION ur WHERE ur.user_id = u.user_id) as reservation_count,
        (SELECT COUNT(*) FROM USER_WISHLIST uw WHERE uw.user_id = u.user_id) as wishlist_count,
        (SELECT COUNT(*) FROM REPORT r WHERE r.user_id = u.user_id) as report_count
        FROM USER u
        LEFT JOIN USER_SOCIAL us ON u.user_id = us.user_id
        LEFT JOIN USER_GENERAL ug ON u.user_id = ug.user_id
        WHERE u.user_id = #{userId}
    </select>

    <!-- 유저 상태 변경 -->
    <update id="updateUserStatus">
        UPDATE USER
        SET user_status = #{status},
        updated_at = CURRENT_TIMESTAMP
        WHERE user_id = #{userId}
    </update>

    <!-- 유저 권한 변경 -->
    <update id="updateUserRole">
        UPDATE USER
        SET user_role = #{role},
        updated_at = CURRENT_TIMESTAMP
        WHERE user_id = #{userId}
    </update>

    <!-- 유저 검색 -->
    <select id="searchUsers" resultMap="UserListResultMap">
        SELECT
        u.user_id,
        u.user_name,
        u.user_nickname,
        u.user_email,
        u.user_phonenumber,
        u.user_gender,
        u.user_birthyear,
        u.user_status,
        u.user_role,
        u.user_photo,
        u.created_at,
        us.oauth_provider,
        us.oauth_id,
        ug.login_id,
        (SELECT COUNT(*) FROM USER_RESERVATION ur WHERE ur.user_id = u.user_id) as reservation_count,
        (SELECT COUNT(*) FROM USER_WISHLIST uw WHERE uw.user_id = u.user_id) as wishlist_count,
        (SELECT COUNT(*) FROM REPORT r WHERE r.user_id = u.user_id) as report_count
        FROM USER u
        LEFT JOIN USER_SOCIAL us ON u.user_id = us.user_id
        LEFT JOIN USER_GENERAL ug ON u.user_id = ug.user_id
        WHERE (u.user_name LIKE CONCAT('%', #{keyword}, '%')
        OR u.user_nickname LIKE CONCAT('%', #{keyword}, '%')
        OR u.user_email LIKE CONCAT('%', #{keyword}, '%'))
        AND u.user_status != 'deleted'
        ORDER BY
        <choose>
            <when test="pageRequest.sortBy == 'userName'">u.user_name</when>
            <when test="pageRequest.sortBy == 'userEmail'">u.user_email</when>
            <when test="pageRequest.sortBy == 'userStatus'">u.user_status</when>
            <otherwise>u.created_at</otherwise>
        </choose>
        ${pageRequest.sortDir}
        LIMIT #{pageRequest.size} OFFSET #{pageRequest.offset}
    </select>

    <select id="countSearchUsers" resultType="long">
        SELECT COUNT(*) FROM USER u
        WHERE (u.user_name LIKE CONCAT('%', #{keyword}, '%')
        OR u.user_nickname LIKE CONCAT('%', #{keyword}, '%')
        OR u.user_email LIKE CONCAT('%', #{keyword}, '%'))
        AND u.user_status != 'deleted'
    </select>

</mapper>