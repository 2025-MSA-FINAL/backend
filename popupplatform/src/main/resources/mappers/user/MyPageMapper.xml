<!-- src/main/resources/mapper/MyPageMapper.xml -->
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.popspot.popupplatform.mapper.user.MyPageMapper">

    <!-- ==========================
         예약 리스트 페이징
         ========================== -->
    <select id="findReservationsByUser"
            parameterType="map"
            resultType="com.popspot.popupplatform.dto.user.ReservationListItemDto">
        SELECT
        ur.ur_id           AS reservationId,
        p.pop_id           AS popupId,
        p.pop_name         AS popupName,
        p.pop_thumbnail    AS popupThumbnail,
        p.pop_location     AS popupLocation,
        ur.ur_date_time    AS reserveDateTime,
        ur.ur_user_cnt     AS reserveUserCount,
        ur.ur_status       AS reserveStatus,
        p.pop_price        AS price
        FROM USER_RESERVATION ur
        JOIN POPUPSTORE p ON ur.pop_id = p.pop_id
        WHERE ur.user_id = #{userId}
        <!-- ✅ 예약 상태 필터: Enum 이름 기준 (ALL / CONFIRMED / CANCELLED) -->
        <if test="reserveStatusFilter == 'CONFIRMED'">
            AND ur.ur_status = 1
        </if>
        <if test="reserveStatusFilter == 'CANCELLED'">
            AND ur.ur_status = 0
        </if>
        <!-- ✅ 정렬: sortDir(ASC/DESC)에 따라 -->
        ORDER BY
        <choose>
            <when test="sortDir == 'ASC'">
                ur.ur_date_time ASC
            </when>
            <otherwise>
                ur.ur_date_time DESC
            </otherwise>
        </choose>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countReservationsByUser"
            parameterType="map"
            resultType="long">
        SELECT COUNT(*)
        FROM USER_RESERVATION ur
        WHERE ur.user_id = #{userId}
        <!-- ✅ count에도 동일한 필터 적용 -->
        <if test="reserveStatusFilter == 'CONFIRMED'">
            AND ur.ur_status = 1
        </if>
        <if test="reserveStatusFilter == 'CANCELLED'">
            AND ur.ur_status = 0
        </if>
    </select>

    <!-- ==========================
         찜 리스트 페이징
         ========================== -->
    <select id="findWishlistByUser"
            parameterType="map"
            resultType="com.popspot.popupplatform.dto.user.WishlistItemDto">
        SELECT
        p.pop_id            AS popupId,
        p.pop_name          AS popupName,
        p.pop_thumbnail     AS popupThumbnail,
        p.pop_location      AS popupLocation,
        p.pop_price         AS popPrice,
        p.pop_start_date    AS startDate,
        p.pop_end_date      AS endDate,
        p.pop_status        AS popupStatus
        FROM USER_WISHLIST uw
        JOIN POPUPSTORE p ON uw.pop_id = p.pop_id
        WHERE uw.user_id = #{userId}
        <!-- ✅ 찜 상태 필터: Enum 이름 기준 (ALL / UPCOMING / ONGOING / ENDED) -->
        <if test="popupStatusFilter == 'UPCOMING'">
            AND p.pop_status = 'UPCOMING'
        </if>
        <if test="popupStatusFilter == 'ENDED'">
            AND p.pop_status = 'ENDED'
        </if>
        <if test="popupStatusFilter == 'ONGOING'">
            AND p.pop_status != 'UPCOMING'
            AND p.pop_status != 'ENDED'
        </if>
        <!-- ✅ 정렬: sortDir(ASC/DESC)에 따라 -->
        ORDER BY
        <choose>
            <when test="sortDir == 'ASC'">
                uw.created_at ASC
            </when>
            <otherwise>
                uw.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countWishlistByUser"
            parameterType="map"
            resultType="long">
        SELECT COUNT(*)
        FROM USER_WISHLIST uw
        JOIN POPUPSTORE p ON uw.pop_id = p.pop_id
        WHERE uw.user_id = #{userId}
        <!-- ✅ count에도 동일한 필터 적용 -->
        <if test="popupStatusFilter == 'UPCOMING'">
            AND p.pop_status = 'UPCOMING'
        </if>
        <if test="popupStatusFilter == 'ENDED'">
            AND p.pop_status = 'ENDED'
        </if>
        <if test="popupStatusFilter == 'ONGOING'">
            AND p.pop_status != 'UPCOMING'
            AND p.pop_status != 'ENDED'
        </if>
    </select>

    <!-- ==========================
         찜 전체 삭제 / 종료된 찜 삭제
         ========================== -->
    <delete id="deleteAllWishList">
        DELETE uw
        FROM USER_WISHLIST uw
        WHERE uw.user_id = #{userId}
    </delete>

    <delete id="deleteCloseWishList">
        DELETE uw
        FROM USER_WISHLIST uw
        JOIN POPUPSTORE p ON uw.pop_id = p.pop_id
        WHERE uw.user_id = #{userId}
        AND p.pop_status = #{popStatus}
    </delete>
</mapper>
