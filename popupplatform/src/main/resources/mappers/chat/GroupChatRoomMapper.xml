<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.popspot.popupplatform.mapper.chat.GroupChatRoomMapper">
    <insert id="insertRoom"
            useGeneratedKeys="true"
            keyProperty="gcrId"
            parameterType="com.popspot.popupplatform.domain.chat.GroupChatRoom">
        INSERT INTO GROUP_CHAT_ROOM (
        pop_id, user_id, cm_id,
        gcr_title,
        gcr_description,
        gcr_max_user_cnt,
        gcr_limit_gender,
        gcr_min_age,
        gcr_max_age,
        gcr_is_deleted
        ) VALUES (
        #{popId},
        #{userId},
        0,
        #{gcrTitle},
        #{gcrDescription},
        #{gcrMaxUserCnt},
        #{gcrLimitGender},
        #{gcrMinAge},
        #{gcrMaxAge},
        FALSE
        );
    </insert>
    <select id="findRoomsByPopId" resultType="com.popspot.popupplatform.dto.chat.response.GroupChatRoomListResponse">
        SELECT
        gcr.gcr_id      AS gcrId,
        gcr.gcr_title   AS title,
        gcr.gcr_description AS description,
        gcr.gcr_max_user_cnt AS maxUserCnt,
        (SELECT COUNT(*) FROM CHAT_PARTICIPANT cp
        WHERE cp.gcr_id = gcr.gcr_id) AS currentUserCnt,
        gcr.gcr_limit_gender AS limitGender,
        gcr.gcr_min_age      AS minAge,
        gcr.gcr_max_age      AS maxAge,
        (
        SELECT CASE WHEN COUNT(*) > 0 THEN TRUE ELSE FALSE END
        FROM CHAT_PARTICIPANT cp2
        WHERE cp2.gcr_id = gcr.gcr_id
        AND cp2.user_id = #{userId}
        ) AS joined
        FROM GROUP_CHAT_ROOM gcr
        WHERE gcr.pop_id = #{popId}
        AND gcr.gcr_is_deleted = FALSE
        ORDER BY gcr.gcr_id DESC
    </select>
    <select id="findById" resultType="com.popspot.popupplatform.domain.chat.GroupChatRoom">
        SELECT
        gcr.gcr_id            AS gcrId,
        gcr.pop_id            AS popId,
        gcr.user_id           AS userId,
        gcr.cm_id             AS cmId,
        gcr.gcr_title         AS gcrTitle,
        gcr.gcr_description   AS gcrDescription,
        gcr.gcr_max_user_cnt  AS gcrMaxUserCnt,
        gcr.gcr_limit_gender  AS gcrLimitGender,
        gcr.gcr_min_age       AS gcrMinAge,
        gcr.gcr_max_age       AS gcrMaxAge,
        gcr.gcr_is_deleted    AS gcrIsDeleted
        FROM GROUP_CHAT_ROOM gcr
        WHERE gcr.gcr_id = #{gcrId}
    </select>
    <update id="updateRoom" parameterType="com.popspot.popupplatform.domain.chat.GroupChatRoom">
        UPDATE GROUP_CHAT_ROOM
        SET
        gcr_title = #{gcrTitle},
        gcr_description = #{gcrDescription},
        gcr_max_user_cnt = #{gcrMaxUserCnt}
        WHERE gcr_id = #{gcrId}
    </update>
    <update id="deleteRoom" parameterType="long">
        UPDATE GROUP_CHAT_ROOM
        SET gcr_is_deleted = TRUE
        WHERE gcr_id = #{gcrId}
    </update>
    <select id="findRoomDetail"
            parameterType="long"
            resultType="com.popspot.popupplatform.dto.chat.response.GroupChatRoomDetailResponse">

        SELECT
        g.gcr_id           AS gcrId,
        g.pop_id           AS popId,
        p.pop_name         AS popName,
        g.user_id          AS ownerId,
        g.gcr_title        AS title,
        g.gcr_description  AS description,
        g.gcr_max_user_cnt AS maxUserCnt,
        g.gcr_limit_gender AS limitGender,
        g.gcr_min_age      AS minAge,
        g.gcr_max_age      AS maxAge,
        (
        SELECT COUNT(*)
        FROM CHAT_PARTICIPANT cp
        WHERE cp.gcr_id = g.gcr_id
        ) AS currentUserCnt
        FROM GROUP_CHAT_ROOM g
        JOIN POPUPSTORE p ON p.pop_id = g.pop_id
        WHERE g.gcr_id = #{gcrId}
        LIMIT 1
    </select>
    <select id="findGroupRoomsForUser"
            resultType="com.popspot.popupplatform.dto.chat.response.ChatRoomSummaryResponse">
        SELECT
        'GROUP'          AS roomType,
        g.gcr_id         AS roomId,
        g.gcr_title      AS roomName,
        NULL             AS otherUserId,
        g.created_at     AS createdAt
        FROM GROUP_CHAT_ROOM g
        JOIN CHAT_PARTICIPANT cp
        ON cp.gcr_id = g.gcr_id
        AND cp.user_id = #{userId}
        LEFT JOIN CHAT_ROOM_HIDDEN h
        ON h.crh_type = 'GROUP'
        AND h.crh_room_id = g.gcr_id
        AND h.user_id = #{userId}
        WHERE g.gcr_is_deleted = FALSE
        AND (h.crh_is_hidden IS NULL OR h.crh_is_hidden = FALSE)
        ORDER BY g.created_at DESC
    </select>
</mapper>