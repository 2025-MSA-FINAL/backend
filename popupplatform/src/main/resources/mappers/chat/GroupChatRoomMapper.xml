<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.popspot.popupplatform.mapper.chat.GroupChatRoomMapper">
    <insert id="insertRoom"
            useGeneratedKeys="true"
            keyProperty="gcrId"
            parameterType="com.popspot.popupplatform.domain.chat.GroupChatRoom">
        INSERT INTO GROUP_CHAT_ROOM (
        pop_id, user_id, cm_id,
        gcr_title,
        gcr_description,
        gcr_max_user_cnt,
        gcr_limit_gender,
        gcr_min_age,
        gcr_max_age,
        gcr_is_deleted
        ) VALUES (
        #{popId},
        #{userId},
        0,
        #{gcrTitle},
        #{gcrDescription},
        #{gcrMaxUserCnt},
        #{gcrLimitGender},
        #{gcrMinAge},
        #{gcrMaxAge},
        FALSE
        );
    </insert>
    <select id="findRoomsByPopId"
            parameterType="long"
            resultType="com.popspot.popupplatform.dto.chat.response.GroupChatRoomListResponse">

        SELECT
        gcr.gcr_id      AS gcrId,
        gcr.gcr_title   AS title,
        gcr.gcr_description AS description,
        gcr.gcr_max_user_cnt AS maxUserCnt,

        (
        SELECT COUNT(*)
        FROM CHAT_PARTICIPANT cp
        WHERE cp.gcr_id = gcr.gcr_id
        ) AS currentUserCnt,

        gcr.gcr_limit_gender AS limitGender,
        gcr.gcr_min_age      AS minAge,
        gcr.gcr_max_age      AS maxAge

        FROM GROUP_CHAT_ROOM gcr
        WHERE gcr.pop_id = #{popId}
        AND gcr.gcr_is_deleted = FALSE

        ORDER BY gcr.gcr_id DESC
    </select>
</mapper>