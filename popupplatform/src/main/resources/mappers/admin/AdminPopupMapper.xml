<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.popspot.popupplatform.mapper.admin.AdminPopupMapper">

    <resultMap id="PopupStoreListResultMap" type="com.popspot.popupplatform.dto.admin.PopupStoreListDTO">
        <!-- 기본 정보 -->
        <id     property="popId"               column="pop_id"/>
        <result property="popName"             column="pop_name"/>
        <result property="popThumbnail"        column="pop_thumbnail"/>
        <result property="popLocation"         column="pop_location"/>
        <result property="popStartDate"        column="pop_start_date"/>
        <result property="popEndDate"          column="pop_end_date"/>
        <result property="popStatus"           column="pop_status"/>
        <result property="popModerationStatus" column="pop_moderation_status"/>
        <result property="popIsDeleted"        column="pop_is_deleted"/>
        <result property="popViewCount"        column="pop_view_count"/>
        <result property="popPriceType"        column="pop_price_type"/>
        <result property="popPrice"            column="pop_price"/>

        <!-- 운영자 정보 -->
        <result property="popOwnerId"          column="pop_owner_id"/>
        <result property="ownerName"           column="owner_name"/>
        <result property="ownerEmail"          column="owner_email"/>

        <!-- 예약/통계 -->
        <result property="popIsReservation"    column="pop_is_reservation"/>
        <result property="reservationCount"    column="reservation_count"/>
        <result property="wishlistCount"       column="wishlist_count"/>

        <!-- 생성일 -->
        <result property="createdAt"           column="created_at"/>
    </resultMap>


    <!-- ============================
         1) 팝업 목록 조회
         (검색 + 필터 + 정렬 + 페이징)
         + 삭제 상태 필터 추가!
    ============================= -->
    <select id="findPopupList" resultMap="PopupStoreListResultMap">
        SELECT
        p.pop_id,
        p.pop_name,
        p.pop_thumbnail,
        p.pop_location,
        p.pop_start_date,
        p.pop_end_date,
        p.pop_status,
        p.pop_moderation_status,
        p.pop_is_deleted,
        p.pop_view_count,
        p.pop_price_type,
        p.pop_price,
        p.pop_owner_id,
        p.pop_is_reservation,
        u.user_name AS owner_name,
        u.user_email AS owner_email,
        p.created_at,

        (SELECT COUNT(*) FROM USER_RESERVATION ur WHERE ur.pop_id = p.pop_id) AS reservation_count,
        (SELECT COUNT(*) FROM USER_WISHLIST uw WHERE uw.pop_id = p.pop_id) AS wishlist_count

        FROM POPUPSTORE p
        LEFT JOIN USER u ON p.pop_owner_id = u.user_id
        WHERE 1=1

        <!-- =========================
             삭제 상태 필터
             active / deleted / all(null)
        ========================== -->
        <if test="deletedFilter != null and deletedFilter != '' and !deletedFilter.equals('all')">
            <choose>
                <when test="deletedFilter.equals('active')">
                    AND p.pop_is_deleted = FALSE
                </when>
                <when test="deletedFilter.equals('deleted')">
                    AND p.pop_is_deleted = TRUE
                </when>
            </choose>
        </if>

        <!-- =========================
             검색어
        ========================== -->
        <if test="keyword != null and keyword != ''">
            AND (
            p.pop_name LIKE CONCAT('%', #{keyword}, '%')
            OR p.pop_location LIKE CONCAT('%', #{keyword}, '%')
            OR u.user_name LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>

        <!-- =========================
             팝업 상태
        ========================== -->
        <if test="status != null and status != ''">
            <choose>
                <when test="status.equals('active')">
                    AND p.pop_status = 'ONGOING'
                </when>
                <when test="status.equals('upcoming')">
                    AND p.pop_status = 'UPCOMING'
                </when>
                <when test="status.equals('ended')">
                    AND p.pop_status = 'ENDED'
                </when>
                <otherwise>
                    AND p.pop_status = #{status}
                </otherwise>
            </choose>
        </if>

        <!-- =========================
             승인 상태
        ========================== -->
        <if test="moderation != null and moderation != ''">
            <choose>
                <when test="moderation.equals('pending')">
                    AND p.pop_moderation_status IS NULL
                </when>
                <when test="moderation.equals('approved')">
                    AND p.pop_moderation_status = 1
                </when>
                <when test="moderation.equals('rejected')">
                    AND p.pop_moderation_status = 0
                </when>
            </choose>
        </if>

        <!-- =========================
             정렬
        ========================== -->
        ORDER BY
        <choose>
            <when test="pageRequest.sortBy != null and pageRequest.sortBy.equals('popName')">
                p.pop_name
            </when>
            <when test="pageRequest.sortBy != null and pageRequest.sortBy.equals('popStartDate')">
                p.pop_start_date
            </when>
            <when test="pageRequest.sortBy != null and pageRequest.sortBy.equals('popStatus')">
                p.pop_status
            </when>
            <when test="pageRequest.sortBy != null and pageRequest.sortBy.equals('popViewCount')">
                p.pop_view_count
            </when>
            <otherwise>
                p.created_at
            </otherwise>
        </choose>
        ${pageRequest.sortDir}

        LIMIT #{pageRequest.size}
        OFFSET #{pageRequest.offset}
    </select>



    <!-- ============================
         2) 총 개수 조회
         + 삭제 상태 필터 추가!
    ============================= -->
    <select id="countPopupList" resultType="long">
        SELECT COUNT(*)
        FROM POPUPSTORE p
        LEFT JOIN USER u ON p.pop_owner_id = u.user_id
        WHERE 1=1

        <!-- 삭제 상태 필터 -->
        <if test="deletedFilter != null and deletedFilter != '' and !deletedFilter.equals('all')">
            <choose>
                <when test="deletedFilter.equals('active')">
                    AND p.pop_is_deleted = FALSE
                </when>
                <when test="deletedFilter.equals('deleted')">
                    AND p.pop_is_deleted = TRUE
                </when>
            </choose>
        </if>

        <!-- 검색 -->
        <if test="keyword != null and keyword != ''">
            AND (
            p.pop_name LIKE CONCAT('%', #{keyword}, '%')
            OR p.pop_location LIKE CONCAT('%', #{keyword}, '%')
            OR u.user_name LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>

        <!-- 상태 -->
        <if test="status != null and status != ''">
            <choose>
                <when test="status.equals('active')">
                    AND p.pop_status = 'ONGOING'
                </when>
                <when test="status.equals('upcoming')">
                    AND p.pop_status = 'UPCOMING'
                </when>
                <when test="status.equals('ended')">
                    AND p.pop_status = 'ENDED'
                </when>
                <otherwise>
                    AND p.pop_status = #{status}
                </otherwise>
            </choose>
        </if>

        <!-- 승인 상태 -->
        <if test="moderation != null and moderation != ''">
            <choose>
                <when test="moderation.equals('pending')">
                    AND p.pop_moderation_status IS NULL
                </when>
                <when test="moderation.equals('approved')">
                    AND p.pop_moderation_status = 1
                </when>
                <when test="moderation.equals('rejected')">
                    AND p.pop_moderation_status = 0
                </when>
            </choose>
        </if>
    </select>


    <!-- ============================
         3) 전체 통계 조회 (필터 무관)
    ============================= -->
    <select id="getPopupStats" resultType="map">
        SELECT
        COUNT(*) AS total,
        SUM(CASE WHEN pop_moderation_status IS NULL THEN 1 ELSE 0 END) AS pending,
        SUM(CASE WHEN pop_status = 'ONGOING' THEN 1 ELSE 0 END) AS active,
        SUM(CASE WHEN pop_status = 'ENDED' THEN 1 ELSE 0 END) AS ended
        FROM POPUPSTORE
        WHERE pop_is_deleted = FALSE
    </select>

    <!-- ============================
         4) 팝업 상세 조회
    ============================= -->
    <select id="findPopupById" resultMap="PopupStoreListResultMap">
        SELECT
        p.pop_id,
        p.pop_name,
        p.pop_thumbnail,
        p.pop_location,
        p.pop_start_date,
        p.pop_end_date,
        p.pop_status,
        p.pop_moderation_status,
        p.pop_is_deleted,
        p.pop_view_count,
        p.pop_price_type,
        p.pop_price,
        p.pop_owner_id,
        p.pop_is_reservation,
        u.user_name AS owner_name,
        u.user_email AS owner_email,
        p.created_at,
        (SELECT COUNT(*) FROM USER_RESERVATION ur WHERE ur.pop_id = p.pop_id) AS reservation_count,
        (SELECT COUNT(*) FROM USER_WISHLIST uw WHERE uw.pop_id = p.pop_id) AS wishlist_count
        FROM POPUPSTORE p
        LEFT JOIN USER u ON p.pop_owner_id = u.user_id
        WHERE p.pop_id = #{popId}
    </select>

    <!-- ============================
         5) 승인 상태 변경 (자유롭게 변경 가능)
         - 승인: status = 1 (true)
         - 거절: status = 0 (false)
         - 대기: status = null
          조건 제거: 어떤 상태에서든 변경 가능!
    ============================= -->
    <update id="updateModerationStatus">
        UPDATE POPUPSTORE
        SET pop_moderation_status = #{status},
        updated_at = CURRENT_TIMESTAMP
        WHERE pop_id = #{popId}
        AND pop_is_deleted = FALSE
    </update>

    <!-- ============================
         6) 팝업 상태 변경
    ============================= -->
    <update id="updatePopupStatus">
        UPDATE POPUPSTORE
        SET pop_status = #{status},
        updated_at = CURRENT_TIMESTAMP
        WHERE pop_id = #{popId}
        AND pop_is_deleted = FALSE
    </update>

    <!-- ============================
         7) 팝업 삭제 (Soft Delete)
    ============================= -->
    <update id="deletePopup">
        UPDATE POPUPSTORE
        SET pop_is_deleted = TRUE,
        updated_at = CURRENT_TIMESTAMP
        WHERE pop_id = #{popId}
        AND pop_is_deleted = FALSE
    </update>

    <!-- ============================
         8) 팝업 복구 (삭제 취소)
    ============================= -->
    <update id="restorePopup">
        UPDATE POPUPSTORE
        SET pop_is_deleted = FALSE,
        updated_at = CURRENT_TIMESTAMP
        WHERE pop_id = #{popId}
        AND pop_is_deleted = TRUE
    </update>

    <!-- ============================
         9) 팝업 상태 변경 이력
    ============================= -->

    <insert id="insertPopupModeration">
        INSERT INTO POPUP_MODERATION (
        pop_id,
        admin_id,
        pm_status,
        pm_comment,
        created_at
        )
        VALUES (
        #{popId},
        #{adminId},
        #{status},
        #{comment},
        CURRENT_TIMESTAMP
        )
    </insert>




    <!--AI / 도메인용 팝업스토어 상세 조회-->
    <select id="findPopupEntityById"
            parameterType="long"
            resultType="com.popspot.popupplatform.domain.popup.PopupStore">
        SELECT
        pop_id              AS popId,
        pop_owner_id        AS popOwnerId,
        pop_name            AS popName,
        pop_description     AS popDescription,
        pop_thumbnail       AS popThumbnail,
        pop_location        AS popLocation,
        pop_latitude        AS popLatitude,
        pop_longitude       AS popLongitude,
        pop_start_date      AS popStartDate,
        pop_end_date        AS popEndDate,
        pop_is_reservation  AS popIsReservation,
        pop_price_type      AS popPriceType,
        pop_price           AS popPrice,
        pop_status          AS popStatus,
        pop_insta_url       AS popInstaUrl,
        pop_moderation_status AS popModerationStatus,
        pop_is_deleted      AS popIsDeleted,
        pop_view_count      AS popViewCount,
        pop_ai_summary      AS popAiSummary
        FROM POPUPSTORE
        WHERE pop_id = #{popId}
        AND pop_is_deleted = FALSE
    </select>

    <select id="findPopupsByIds"
            resultMap="PopupStoreListResultMap">
        SELECT *
        FROM POPUPSTORE
        WHERE pop_id IN
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        ORDER BY FIELD(pop_id,
        <foreach collection="list" item="id" separator=",">
            #{id}
        </foreach>
        )
    </select>

</mapper>