<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.popspot.popupplatform.mapper.admin.AdminPopupMapper">

    <resultMap id="PopupStoreListResultMap" type="com.popspot.popupplatform.dto.admin.PopupStoreListDTO">
        <id property="popId" column="pop_id"/>
        <result property="popName" column="pop_name"/>
        <result property="popThumbnail" column="pop_thumbnail"/>
        <result property="popLocation" column="pop_location"/>
        <result property="popStartDate" column="pop_start_date"/>
        <result property="popEndDate" column="pop_end_date"/>
        <result property="popStatus" column="pop_status"/>
        <result property="popModerationStatus" column="pop_moderation_status"/>
        <result property="popIsDeleted" column="pop_is_deleted"/>
        <result property="popViewCount" column="pop_view_count"/>
        <result property="popPriceType" column="pop_price_type"/>
        <result property="popPrice" column="pop_price"/>
        <result property="popOwnerId" column="pop_owner_id"/>
        <result property="ownerName" column="owner_name"/>
        <result property="ownerEmail" column="owner_email"/>
        <result property="popIsReservation" column="pop_is_reservation"/>
        <result property="reservationCount" column="reservation_count"/>
        <result property="wishlistCount" column="wishlist_count"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 팝업스토어 목록 조회 -->
    <select id="findPopupList" resultMap="PopupStoreListResultMap">
        SELECT
        p.pop_id,
        p.pop_name,
        p.pop_thumbnail,
        p.pop_location,
        p.pop_start_date,
        p.pop_end_date,
        p.pop_status,
        p.pop_moderation_status,
        p.pop_is_deleted,
        p.pop_view_count,
        p.pop_price_type,
        p.pop_price,
        p.pop_owner_id,
        p.pop_is_reservation,
        u.user_name as owner_name,
        u.user_email as owner_email,
        p.created_at,
        (SELECT COUNT(*) FROM USER_RESERVATION ur WHERE ur.pop_id = p.pop_id) as reservation_count,
        (SELECT COUNT(*) FROM USER_WISHLIST uw WHERE uw.pop_id = p.pop_id) as wishlist_count
        FROM POPUPSTORE p
        LEFT JOIN USER u ON p.pop_owner_id = u.user_id
        WHERE p.pop_is_deleted = FALSE
        ORDER BY
        <choose>
            <when test="sortBy == 'popName'">p.pop_name</when>
            <when test="sortBy == 'popStartDate'">p.pop_start_date</when>
            <when test="sortBy == 'popStatus'">p.pop_status</when>
            <when test="sortBy == 'popViewCount'">p.pop_view_count</when>
            <otherwise>p.created_at</otherwise>
        </choose>
        ${sortDir}
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countPopupList" resultType="long">
        SELECT COUNT(*) FROM POPUPSTORE
        WHERE pop_is_deleted = FALSE
    </select>

    <!-- 승인 대기 목록 조회 -->
    <select id="findPendingPopupList" resultMap="PopupStoreListResultMap">
        SELECT
        p.pop_id,
        p.pop_name,
        p.pop_thumbnail,
        p.pop_location,
        p.pop_start_date,
        p.pop_end_date,
        p.pop_status,
        p.pop_moderation_status,
        p.pop_is_deleted,
        p.pop_view_count,
        p.pop_price_type,
        p.pop_price,
        p.pop_owner_id,
        p.pop_is_reservation,
        u.user_name as owner_name,
        u.user_email as owner_email,
        p.created_at,
        (SELECT COUNT(*) FROM USER_RESERVATION ur WHERE ur.pop_id = p.pop_id) as reservation_count,
        (SELECT COUNT(*) FROM USER_WISHLIST uw WHERE uw.pop_id = p.pop_id) as wishlist_count
        FROM POPUPSTORE p
        LEFT JOIN USER u ON p.pop_owner_id = u.user_id
        WHERE p.pop_is_deleted = FALSE
        AND p.pop_moderation_status IS NULL
        ORDER BY p.created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countPendingPopupList" resultType="long">
        SELECT COUNT(*) FROM POPUPSTORE
        WHERE pop_is_deleted = FALSE
        AND pop_moderation_status IS NULL
    </select>

    <!-- 팝업스토어 상세 조회 -->
    <select id="findPopupById" resultMap="PopupStoreListResultMap">
        SELECT
        p.pop_id,
        p.pop_name,
        p.pop_thumbnail,
        p.pop_location,
        p.pop_start_date,
        p.pop_end_date,
        p.pop_status,
        p.pop_moderation_status,
        p.pop_is_deleted,
        p.pop_view_count,
        p.pop_price_type,
        p.pop_price,
        p.pop_owner_id,
        p.pop_is_reservation,
        u.user_name as owner_name,
        u.user_email as owner_email,
        p.created_at,
        (SELECT COUNT(*) FROM USER_RESERVATION ur WHERE ur.pop_id = p.pop_id) as reservation_count,
        (SELECT COUNT(*) FROM USER_WISHLIST uw WHERE uw.pop_id = p.pop_id) as wishlist_count
        FROM POPUPSTORE p
        LEFT JOIN USER u ON p.pop_owner_id = u.user_id
        WHERE p.pop_id = #{popId}
    </select>

    <!-- 승인/반려 상태 변경 -->
    <update id="updateModerationStatus">
        UPDATE POPUPSTORE
        SET pop_moderation_status = #{status},
        updated_at = CURRENT_TIMESTAMP
        WHERE pop_id = #{popId}
    </update>

    <!-- 팝업스토어 상태 변경 -->
    <update id="updatePopupStatus">
        UPDATE POPUPSTORE
        SET pop_status = #{status},
        updated_at = CURRENT_TIMESTAMP
        WHERE pop_id = #{popId}
    </update>

    <!-- 팝업스토어 삭제 (soft delete) -->
    <update id="deletePopup">
        UPDATE POPUPSTORE
        SET pop_is_deleted = TRUE,
        updated_at = CURRENT_TIMESTAMP
        WHERE pop_id = #{popId}
    </update>

    <!-- 팝업스토어 검색 -->
    <select id="searchPopups" resultMap="PopupStoreListResultMap">
        SELECT
        p.pop_id,
        p.pop_name,
        p.pop_thumbnail,
        p.pop_location,
        p.pop_start_date,
        p.pop_end_date,
        p.pop_status,
        p.pop_moderation_status,
        p.pop_is_deleted,
        p.pop_view_count,
        p.pop_price_type,
        p.pop_price,
        p.pop_owner_id,
        p.pop_is_reservation,
        u.user_name as owner_name,
        u.user_email as owner_email,
        p.created_at,
        (SELECT COUNT(*) FROM USER_RESERVATION ur WHERE ur.pop_id = p.pop_id) as reservation_count,
        (SELECT COUNT(*) FROM USER_WISHLIST uw WHERE uw.pop_id = p.pop_id) as wishlist_count
        FROM POPUPSTORE p
        LEFT JOIN USER u ON p.pop_owner_id = u.user_id
        WHERE p.pop_is_deleted = FALSE
        AND (p.pop_name LIKE CONCAT('%', #{keyword}, '%')
        OR p.pop_location LIKE CONCAT('%', #{keyword}, '%')
        OR u.user_name LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY
        <choose>
            <when test="pageRequest.sortBy == 'popName'">p.pop_name</when>
            <when test="pageRequest.sortBy == 'popStartDate'">p.pop_start_date</when>
            <when test="pageRequest.sortBy == 'popStatus'">p.pop_status</when>
            <when test="pageRequest.sortBy == 'popViewCount'">p.pop_view_count</when>
            <otherwise>p.created_at</otherwise>
        </choose>
        ${pageRequest.sortDir}
        LIMIT #{pageRequest.size} OFFSET #{pageRequest.offset}
    </select>

    <select id="countSearchPopups" resultType="long">
        SELECT COUNT(*) FROM POPUPSTORE p
        LEFT JOIN USER u ON p.pop_owner_id = u.user_id
        WHERE p.pop_is_deleted = FALSE
        AND (p.pop_name LIKE CONCAT('%', #{keyword}, '%')
        OR p.pop_location LIKE CONCAT('%', #{keyword}, '%')
        OR u.user_name LIKE CONCAT('%', #{keyword}, '%'))
    </select>

</mapper>