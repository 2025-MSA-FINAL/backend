<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.popspot.popupplatform.mapper.admin.AdminPopupMapper">

        <resultMap id="PopupStoreListResultMap" type="com.popspot.popupplatform.dto.admin.PopupStoreListDTO">

        <!-- ê¸°ë³¸ ì •ë³´ -->
        <id     property="popId"               column="pop_id"/>
        <result property="popName"             column="pop_name"/>
        <result property="popThumbnail"        column="pop_thumbnail"/>
        <result property="popLocation"         column="pop_location"/>
        <result property="popStartDate"        column="pop_start_date"/>
        <result property="popEndDate"          column="pop_end_date"/>
        <result property="popStatus"           column="pop_status"/>
        <result property="popModerationStatus" column="pop_moderation_status"/>
        <result property="popIsDeleted"        column="pop_is_deleted"/>
        <result property="popViewCount"        column="pop_view_count"/>
        <result property="popPriceType"        column="pop_price_type"/>
        <result property="popPrice"            column="pop_price"/>

        <!-- ìš´ì˜ìž ì •ë³´ -->
        <result property="popOwnerId"          column="pop_owner_id"/>
        <result property="ownerName"           column="owner_name"/>
        <result property="ownerEmail"          column="owner_email"/>

        <!-- ì˜ˆì•½/í†µê³„ -->
        <result property="popIsReservation"    column="pop_is_reservation"/>
        <result property="reservationCount"    column="reservation_count"/>
        <result property="wishlistCount"       column="wishlist_count"/>

        <!-- ìƒì„±ì¼ -->
        <result property="createdAt"           column="created_at"/>

    </resultMap>


    <!-- ============================
         1) íŒì—… ëª©ë¡ ì¡°íšŒ
         (ê²€ìƒ‰ + í•„í„° + ì •ë ¬ + íŽ˜ì´ì§•)
    ============================= -->
    <select id="findPopupList" resultMap="PopupStoreListResultMap">
        SELECT
        p.pop_id,
        p.pop_name,
        p.pop_thumbnail,
        p.pop_location,
        p.pop_start_date,
        p.pop_end_date,
        p.pop_status,
        p.pop_moderation_status,
        p.pop_is_deleted,
        p.pop_view_count,
        p.pop_price_type,
        p.pop_price,
        p.pop_owner_id,
        p.pop_is_reservation,
        u.user_name AS owner_name,
        u.user_email AS owner_email,
        p.created_at,

        /* ì˜ˆì•½ ìˆ˜ / ì°œ ìˆ˜ */
        (SELECT COUNT(*) FROM USER_RESERVATION ur WHERE ur.pop_id = p.pop_id) AS reservation_count,
        (SELECT COUNT(*) FROM USER_WISHLIST uw WHERE uw.pop_id = p.pop_id) AS wishlist_count

        FROM POPUPSTORE p
        LEFT JOIN USER u ON p.pop_owner_id = u.user_id
        WHERE p.pop_is_deleted = FALSE

        <!--  keyword ê²€ìƒ‰ -->
        <if test="keyword != null and keyword != ''">
            AND (
            p.pop_name LIKE CONCAT('%', #{keyword}, '%')
            OR p.pop_location LIKE CONCAT('%', #{keyword}, '%')
            OR u.user_name LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>

        <!-- ðŸ· status í•„í„° -->
        <if test="status != null and status != ''">
            AND p.pop_status = #{status}
        </if>

        <!--  moderation í•„í„° -->
        <if test="moderation != null and moderation != ''">
            AND p.pop_moderation_status = #{moderation}
        </if>

        <!-- ì •ë ¬ -->
        ORDER BY
        <choose>
            <when test="pageRequest.sortBy == 'popName'">p.pop_name</when>
            <when test="pageRequest.sortBy == 'popStartDate'">p.pop_start_date</when>
            <when test="pageRequest.sortBy == 'popStatus'">p.pop_status</when>
            <when test="pageRequest.sortBy == 'popViewCount'">p.pop_view_count</when>
            <otherwise>p.created_at</otherwise>
        </choose>
        ${pageRequest.sortDir}

        <!-- íŽ˜ì´ì§• -->
        LIMIT #{pageRequest.size}
        OFFSET #{pageRequest.offset}
    </select>


    <!-- ============================
         2) ì´ ê°œìˆ˜ ì¡°íšŒ
    ============================= -->
    <select id="countPopupList" resultType="long">
        SELECT COUNT(*)
        FROM POPUPSTORE p
        LEFT JOIN USER u ON p.pop_owner_id = u.user_id
        WHERE p.pop_is_deleted = FALSE

        <if test="keyword != null and keyword != ''">
            AND (
            p.pop_name LIKE CONCAT('%', #{keyword}, '%')
            OR p.pop_location LIKE CONCAT('%', #{keyword}, '%')
            OR u.user_name LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>

        <if test="status != null and status != ''">
            AND p.pop_status = #{status}
        </if>

        <if test="moderation != null and moderation != ''">
            AND p.pop_moderation_status = #{moderation}
        </if>
    </select>


</mapper>
