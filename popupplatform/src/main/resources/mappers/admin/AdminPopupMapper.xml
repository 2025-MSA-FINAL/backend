<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.popspot.popupplatform.mapper.admin.AdminPopupMapper">
    <!-- 팝업스토어 목록 조회 (검색 + 필터 + 정렬 + 페이징) -->
    <select id="findPopupList" resultMap="PopupStoreListResultMap">
        SELECT
        p.pop_id,
        p.pop_name,
        p.pop_thumbnail,
        p.pop_location,
        p.pop_start_date,
        p.pop_end_date,
        p.pop_status,
        p.pop_moderation_status,
        p.pop_is_deleted,
        p.pop_view_count,
        p.pop_price_type,
        p.pop_price,
        p.pop_owner_id,
        p.pop_is_reservation,
        u.user_name AS owner_name,
        u.user_email AS owner_email,
        p.created_at,
        (SELECT COUNT(*) FROM USER_RESERVATION ur WHERE ur.pop_id = p.pop_id) AS reservation_count,
        (SELECT COUNT(*) FROM USER_WISHLIST uw WHERE uw.pop_id = p.pop_id) AS wishlist_count
        FROM POPUPSTORE p
        LEFT JOIN USER u ON p.pop_owner_id = u.user_id
        WHERE p.pop_is_deleted = FALSE

        <!-- keyword 검색 -->
        <if test="keyword != null and keyword != ''">
            AND (
            p.pop_name LIKE CONCAT('%', #{keyword}, '%')
            OR p.pop_location LIKE CONCAT('%', #{keyword}, '%')
            OR u.user_name LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>

        <!-- status 필터 -->
        <if test="status != null and status != ''">
            AND p.pop_status = #{status}
        </if>

        <!-- moderation 필터 -->
        <if test="moderation != null and moderation != ''">
            AND p.pop_moderation_status = #{moderation}
        </if>

        <!-- 정렬 -->
        ORDER BY
        <choose>
            <when test="pageRequest.sortBy == 'popName'">p.pop_name</when>
            <when test="pageRequest.sortBy == 'popStartDate'">p.pop_start_date</when>
            <when test="pageRequest.sortBy == 'popStatus'">p.pop_status</when>
            <when test="pageRequest.sortBy == 'popViewCount'">p.pop_view_count</when>
            <otherwise>p.created_at</otherwise>
        </choose>
        ${pageRequest.sortDir}

        <!-- 페이징 -->
        LIMIT #{pageRequest.size}
        OFFSET #{pageRequest.offset}
    </select>



    <!-- 총 개수 조회 (검색 + 필터 적용된 count 쿼리) -->
    <select id="countPopupList" resultType="long">
    SELECT COUNT(*)
    FROM POPUPSTORE p
    LEFT JOIN USER u ON p.pop_owner_id = u.user_id
    WHERE p.pop_is_deleted = FALSE

    <!-- keyword 검색 -->
    <if test="keyword != null and keyword != ''">
        AND (
        p.pop_name LIKE CONCAT('%', #{keyword}, '%')
        OR p.pop_location LIKE CONCAT('%', #{keyword}, '%')
        OR u.user_name LIKE CONCAT('%', #{keyword}, '%')
        )
    </if>

    <!-- status 필터 -->
    <if test="status != null and status != ''">
        AND p.pop_status = #{status}
    </if>

    <!-- moderation 필터 -->
    <if test="moderation != null">
        AND p.pop_moderation_status = #{moderation}
    </if>
    </select>
</mapper>