<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.popspot.popupplatform.mapper.admin.AdminUserMapper">

    <!-- 검색 조건 SQL 조각 -->
    <sql id="searchCondition">
        <if test="keyword != null and keyword != ''">
            AND (
            <choose>
                <when test='searchType != null and searchType.equals("name")'>
                    user_name LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test='searchType != null and searchType.equals("nickname")'>
                    user_nickname LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test='searchType != null and searchType.equals("email")'>
                    user_email LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <otherwise>
                    user_name LIKE CONCAT('%', #{keyword}, '%')
                    OR user_nickname LIKE CONCAT('%', #{keyword}, '%')
                    OR user_email LIKE CONCAT('%', #{keyword}, '%')
                </otherwise>
            </choose>
            )
        </if>
    </sql>

    <!-- 유저 목록 조회 (USER 역할만) -->
    <select id="getUserList" resultType="com.popspot.popupplatform.dto.admin.AdminUserDTO">
        SELECT
        user_id AS userId,
        user_name AS userName,
        user_nickname AS userNickname,
        user_email AS userEmail,
        user_phonenumber AS userPhonenumber,
        user_gender AS userGender,
        user_birthyear AS userBirthyear,
        user_status AS userStatus,
        user_role AS userRole,
        created_at AS createdAt,
        updated_at AS updatedAt
        FROM USER
        WHERE user_role = 'USER'
        <if test="status != null and !status.equals('ALL')">
            AND user_status = #{status}
        </if>
        <include refid="searchCondition"/>
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 매니저 목록 조회 (MANAGER 역할만) -->
    <select id="getManagerList" resultType="com.popspot.popupplatform.dto.admin.AdminUserDTO">
        SELECT
        user_id AS userId,
        user_name AS userName,
        user_nickname AS userNickname,
        user_email AS userEmail,
        user_phonenumber AS userPhonenumber,
        user_gender AS userGender,
        user_birthyear AS userBirthyear,
        user_status AS userStatus,
        user_role AS userRole,
        created_at AS createdAt,
        updated_at AS updatedAt
        FROM USER
        WHERE user_role = 'MANAGER'
        <if test="status != null and !status.equals('ALL')">
            AND user_status = #{status}
        </if>
        <include refid="searchCondition"/>
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 유저 총 개수 -->
    <select id="getUserCount" resultType="int">
        SELECT COUNT(*)
        FROM USER
        WHERE user_role = 'USER'
        <if test="status != null and !status.equals('ALL')">
            AND user_status = #{status}
        </if>
        <include refid="searchCondition"/>
    </select>

    <!-- 매니저 총 개수 -->
    <select id="getManagerCount" resultType="int">
        SELECT COUNT(*)
        FROM USER
        WHERE user_role = 'MANAGER'
        <if test="status != null and !status.equals('ALL')">
            AND user_status = #{status}
        </if>
        <include refid="searchCondition"/>
    </select>

    <!-- 유저 상태 변경 -->
    <update id="updateUserStatus">
        UPDATE USER
        SET user_status = #{status},
        updated_at = CURRENT_TIMESTAMP
        WHERE user_id = #{userId}
    </update>

    <!-- 유저 권한 변경 -->
    <update id="updateUserRole">
        UPDATE USER
        SET user_role = #{role},
        updated_at = CURRENT_TIMESTAMP
        WHERE user_id = #{userId}
    </update>

</mapper>