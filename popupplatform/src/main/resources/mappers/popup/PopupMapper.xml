<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    PopupMapper.xml
      - POPUPSTORE 테이블에 팝업 기본 정보 INSERT
      - HASHTAG 테이블에서 해시태그 ID 조회/INSERT
      - POPUP_HASHTAG 테이블에 팝업-해시태그 매핑 INSERT

    주의점
      - insertPopup:
          * useGeneratedKeys="true" / keyProperty="popId"
          * DB에서 생성된 pop_id가 PopupStore.popId에 자동 세팅됨
      - pop_price_type / pop_status:
          * EnumTypeHandler를 통해 Enum.name() 문자열로 저장됨 (예: FREE, PAID, UPCOMING...)
      - pop_moderation_status, pop_is_deleted, pop_view_count, pop_ai_summary:
          * INSERT 시 기본값을 코드에서 직접 지정 (상태 초기화 역할)
-->

<mapper namespace="com.popspot.popupplatform.mapper.popup.PopupMapper">

    <!-- PopupStore 매핑용 resultMap -->
    <resultMap id="PopupStoreResultMap" type="com.popspot.popupplatform.domain.popup.PopupStore">
        <id     property="popId"              column="pop_id"/>
        <result property="popOwnerId"         column="pop_owner_id"/>
        <result property="popName"            column="pop_name"/>
        <result property="popDescription"     column="pop_description"/>
        <result property="popThumbnail"       column="pop_thumbnail"/>
        <result property="popLocation"        column="pop_location"/>
        <result property="popLatitude"        column="pop_latitude"/>
        <result property="popLongitude"       column="pop_longitude"/>
        <result property="popStartDate"       column="pop_start_date"/>
        <result property="popEndDate"         column="pop_end_date"/>
        <result property="popIsReservation"   column="pop_is_reservation"/>
        <result property="popPriceType"       column="pop_price_type"/>
        <result property="popPrice"           column="pop_price"/>
        <result property="popStatus"          column="pop_status"/>
        <result property="popInstaUrl"        column="pop_insta_url"/>
        <result property="popModerationStatus" column="pop_moderation_status"/>
        <result property="popIsDeleted"       column="pop_is_deleted"/>
        <result property="popViewCount"       column="pop_view_count"/>
        <result property="popAiSummary"       column="pop_ai_summary"/>
        <result property="popPopularityScore" column="popularity_score"/>
    </resultMap>



    <!--
        1) 팝업 기본 정보 INSERT

        - 파라미터: PopupStore 도메인 객체
        - 동작:
            * POPUPSTORE 테이블에 한 행 INSERT
            * useGeneratedKeys:
                - AUTO_INCREMENT pop_id 값을 DB가 생성
                - 생성된 PK를 PopupStore.popId 필드에 자동으로 채워줌
        - 초기값:
            * pop_moderation_status : FALSE (관리자 승인 전 상태)
            * pop_is_deleted        : FALSE (소프트 삭제 안된 상태)
            * pop_view_count        : 0     (조회수 초기값)
            * pop_ai_summary        : NULL  (AI 요약 아직 없음)
    -->
    <insert id="insertPopup"
            useGeneratedKeys="true"
            keyProperty="popId"
            parameterType="com.popspot.popupplatform.domain.popup.PopupStore">
        INSERT INTO POPUPSTORE (
        pop_owner_id,
        pop_name,
        pop_description,
        pop_thumbnail,
        pop_location,
        pop_latitude,
        pop_longitude,
        pop_start_date,
        pop_end_date,
        pop_is_reservation,
        pop_price_type,
        pop_price,
        pop_status,
        pop_insta_url,
        pop_moderation_status,
        pop_is_deleted,
        pop_view_count,
        pop_ai_summary
        ) VALUES (
        #{popOwnerId},
        #{popName},
        #{popDescription},
        #{popThumbnail},
        #{popLocation},
        #{popLatitude},
        #{popLongitude},
        #{popStartDate},
        #{popEndDate},
        #{popIsReservation},
        #{popPriceType},
        #{popPrice},
        #{popStatus},
        #{popInstaUrl},
        FALSE,
        FALSE,
        0,
        #{popAiSummary}
        )
    </insert>

    <!--
        2) 해시태그 이름으로 hash_id 조회

        - 파라미터: hashName (해시태그 문자열)
        - 반환값: hash_id (Long)
        - 용도:
            * 이미 존재하는 해시태그인지 확인할 때 사용
            * 결과가 없으면 서비스 레이어에서 insertHashtag 호출
    -->
    <select id="findHashtagIdByName" resultType="java.lang.Long">
        SELECT hash_id
        FROM HASHTAG
        WHERE hash_name = #{hashName}
    </select>

    <!--
        3) 해시태그 INSERT

        - 파라미터: hashName
        - 동작:
            * HASHTAG 테이블에 새로운 해시태그 한 건 INSERT
        - 주의:
            * 현재는 생성된 hash_id를 반환하지 않음
            * 필요하다면 useGeneratedKeys + Ha>shtag 도메인 객체로 바꾸는 것도 고려 가능
    -->
    <insert id="insertHashtag">
        INSERT IGNORE INTO HASHTAG (hash_name)
        VALUES (#{hashName})
    </insert>

    <!--
        4) 팝업-해시태그 매핑 INSERT

        - 파라미터:
            * popId  : POPUPSTORE.pop_id
            * hashId : HASHTAG.hash_id
        - 동작:
            * POPUP_HASHTAG 테이블에 (팝업, 해시태그) N:M 관계를 한 건 등록
        - 사용 시나리오:
            * 팝업 생성 후, DTO에 들어온 해시태그 리스트를 순회하면서
              각 해시태그에 대해 POPUP_HASHTAG 행을 추가하는 용도
    -->
    <insert id="insertPopupHashtag">
        INSERT INTO POPUP_HASHTAG (pop_id, hash_id)
        VALUES (#{popId}, #{hashId})
    </insert>

    <!--
        5) 팝업-이미지 매핑 INSERT
    -->
    <insert id="insertPopupImage">
        INSERT INTO POPUP_IMG (pop_id, pi_url, pi_order)
        VALUES (#{popId}, #{imageUrl}, #{order})
    </insert>


    <!--
        6) 팝업 존재 확인
    -->
    <select id="existsById" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM POPUPSTORE
        WHERE pop_id = #{popId}
        AND pop_is_deleted = FALSE
    </select>


    <!--
        7) 팝업 목록 기본 조회
     -->
    <select id="selectPopupList"
            resultMap="PopupStoreResultMap">
        SELECT
        pop_id,
        pop_owner_id,
        pop_name,
        pop_description,
        pop_thumbnail,
        pop_location,
        pop_latitude,
        pop_longitude,
        pop_start_date,
        pop_end_date,
        pop_is_reservation,
        pop_price_type,
        pop_price,
        pop_status,
        pop_insta_url,
        pop_moderation_status,
        pop_is_deleted,
        pop_view_count,
        pop_ai_summary,

        (
        IFNULL((
        SELECT COUNT(*)
        FROM POPUP_VIEWED v
        WHERE v.pop_id = ps.pop_id
        AND v.pv_viewed_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
        ), 0)
        +
        3 * IFNULL((
        SELECT COUNT(*)
        FROM USER_WISHLIST w
        WHERE w.pop_id = ps.pop_id
        ), 0)
        ) AS popularity_score


        FROM POPUPSTORE ps
        WHERE pop_is_deleted = FALSE
        <!-- AND pop_moderation_status = TRUE -->

        <!-- 이름 / 해시태그 검색 (다중 키워드 OR) -->
        <if test="keywords != null and keywords.size() > 0">
            AND (
            <foreach collection="keywords" item="kw" separator=" OR ">
                (
                ps.pop_name LIKE CONCAT('%', #{kw}, '%')
                OR EXISTS (
                SELECT 1
                FROM POPUP_HASHTAG ph
                JOIN HASHTAG h ON h.hash_id = ph.hash_id
                WHERE ph.pop_id = ps.pop_id
                AND h.hash_name LIKE CONCAT('%', #{kw}, '%')
                )
                )
            </foreach>
            )
        </if>


        <!-- 지역 필터 -->
        <if test="regions != null and regions.size() > 0">
            AND (
            <foreach collection="regions" item="region" separator=" OR ">
                pop_location LIKE CONCAT('%', #{region}, '%')
            </foreach>
            )
        </if>


        <!-- 기간 필터: 겹치면 포함 -->
        <!-- startDate, endDate 둘 다 있는 경우 -->
        <if test="startDate != null and endDate != null">
            AND pop_start_date &lt;= #{endDate}
            AND pop_end_date   &gt;= #{startDate}
        </if>

        <!-- startDate만 있는 경우: 팝업 종료일이 startDate 이후인 것 -->
        <if test="startDate != null and endDate == null">
            AND pop_end_date &gt;= #{startDate}
        </if>

        <!-- endDate만 있는 경우: 팝업 시작일이 endDate 이전인 것 -->
        <if test="endDate != null and startDate == null">
            AND pop_start_date &lt;= #{endDate}
        </if>

        <!-- 현황(상태) 피러ㅌ -->
        <if test="status != null and status != ''">
            AND FIND_IN_SET(pop_status, #{status}) > 0
        </if>

        <!-- 가격 필터 -->
        <if test="minPrice != null">
            AND pop_price &gt;= #{minPrice}
        </if>

        <if test="maxPrice != null">
            AND pop_price &lt;= #{maxPrice}
        </if>


        <!-- 커서 조건 -->
        <if test="cursorId != null">
            <choose>
                <when test="sort == null or sort == '' or sort == 'DEADLINE'">
                    AND (
                    pop_end_date &gt; #{cursorEndDate}
                    OR (pop_end_date = #{cursorEndDate} AND pop_id &lt; #{cursorId})
                    )
                </when>

                <when test="sort == 'VIEW'">
                    AND (
                    -- 1) statusGroup(0: 진행/예정, 1: 종료)가 커서보다 큰 애들
                    CASE
                    WHEN pop_end_date &gt;= NOW() THEN 0
                    ELSE 1
                    END &gt; #{cursorStatusGroup}
                    OR (
                    -- 2) statusGroup이 같고,
                    CASE
                    WHEN pop_end_date &gt;= NOW() THEN 0
                    ELSE 1
                    END = #{cursorStatusGroup}
                    AND (
                    -- 2-1) 조회수가 더 작은(=정렬상 뒤에 있는) 애들
                    pop_view_count &lt; #{cursorViewCount}
                    OR (
                    pop_view_count = #{cursorViewCount}
                    AND pop_id &lt; #{cursorId}
                    )
                    )
                    )
                    )
                </when>

                <when test="sort == 'POPULAR'">
                    AND (
                    -- 1) statusGroup(0: ENDED 아님, 1: ENDED)가 커서보다 큰 애들
                    CASE
                    WHEN ps.pop_status = 'ENDED' THEN 1
                    ELSE 0
                    END &gt; #{cursorStatusGroup}
                    OR (
                    -- 2) statusGroup이 같고,
                    CASE
                    WHEN ps.pop_status = 'ENDED' THEN 1
                    ELSE 0
                    END = #{cursorStatusGroup}
                    AND (
                    -- 2-1) 인기 점수가 더 작은(=정렬상 뒤에 있는) 애들
                    (
                    IFNULL((
                    SELECT COUNT(*)
                    FROM POPUP_VIEWED v
                    WHERE v.pop_id = ps.pop_id
                    AND v.pv_viewed_at &gt;= DATE_SUB(NOW(), INTERVAL 7 DAY)
                    ), 0)
                    +
                    3 * IFNULL((
                    SELECT COUNT(*)
                    FROM USER_WISHLIST w
                    WHERE w.pop_id = ps.pop_id
                    ), 0)
                    ) &lt; #{cursorViewCount}
                    OR (
                    -- 2-2) 인기 점수가 같으면 pop_id로 tie-break
                    (
                    IFNULL((
                    SELECT COUNT(*)
                    FROM POPUP_VIEWED v
                    WHERE v.pop_id = ps.pop_id
                    AND v.pv_viewed_at &gt;= DATE_SUB(NOW(), INTERVAL 7 DAY)
                    ), 0)
                    +
                    3 * IFNULL((
                    SELECT COUNT(*)
                    FROM USER_WISHLIST w
                    WHERE w.pop_id = ps.pop_id
                    ), 0)
                    ) = #{cursorViewCount}
                    AND ps.pop_id &lt; #{cursorId}
                    )
                    )
                    )
                    )
                </when>

                <otherwise>
                    AND pop_id &lt; #{cursorId}
                </otherwise>
            </choose>
        </if>

        <!-- 정렬 옵션 -->
        <choose>
            <!-- 1) 마감임박순(DEADLINE, 기본값임) -->
            <when test="sort == null or sort == '' or sort == 'DEADLINE'">
                ORDER BY
                pop_end_date ASC,
                pop_id DESC
            </when>

            <!-- 2) 등록순 (CREATED) -->
            <when test="sort == 'CREATED'">
                ORDER BY pop_id DESC
            </when>

            <!-- 3) 조회수순 (VIEW) -->
            <when test="sort == 'VIEW'">
                ORDER BY
                CASE
                WHEN pop_end_date >= NOW() THEN 0
                ELSE 1
                END ASC,
                pop_view_count DESC,
                pop_id DESC
            </when>

            <!-- 4) 인기순 (POPULAR) -->
            <when test="sort == 'POPULAR'">
                ORDER BY
                -- 1) 종료 안 된 팝업(UPCOMING/ONGOING) 우선
                CASE
                WHEN ps.pop_status = 'ENDED' THEN 1
                ELSE 0
                END ASC,

                -- 2) 인기 점수: 최근 7일 조회수 + 찜*3
                (
                IFNULL((
                SELECT COUNT(*)
                FROM POPUP_VIEWED v
                WHERE v.pop_id = ps.pop_id
                AND v.pv_viewed_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
                ), 0)
                +
                3 * IFNULL((
                SELECT COUNT(*)
                FROM USER_WISHLIST w
                WHERE w.pop_id = ps.pop_id
                ), 0)
                ) DESC,

                -- 3) 동점일 때 최신 등록 우선
                ps.pop_id DESC
            </when>

        </choose>

        LIMIT #{limit}
    </select>



    <update id="updateStatusToOngoing">
        UPDATE POPUPSTORE
        SET pop_status = 'ONGOING'
        WHERE pop_status = 'UPCOMING'
        AND pop_start_date &lt;= #{now}
        AND pop_is_deleted = FALSE
    </update>

    <update id="updateStatusToEnded">
        UPDATE POPUPSTORE
        SET pop_status = 'ENDED'
        WHERE pop_status IN ('UPCOMING', 'ONGOING')
        AND pop_end_date &lt;= #{now}
        AND pop_is_deleted = FALSE
    </update>

    <update id="updateIsReservation">
        UPDATE POPUPSTORE
        SET pop_is_reservation = TRUE
        WHERE pop_id = #{popId}
    </update>

    <update id="updateViewCount">
        UPDATE POPUPSTORE
        SET pop_view_count = IFNULL(pop_view_count, 0) + 1
        WHERE pop_id = #{popId}
        AND pop_is_deleted = FALSE
    </update>


    <select id="existsViewHistoryRecent" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM POPUP_VIEWED
        WHERE pop_id = #{popId}
        AND user_id = #{userId}
        AND pv_viewed_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)
    </select>

    <insert id="insertViewHistory">
        INSERT INTO POPUP_VIEWED (pop_id, user_id, pv_viewed_at)
        VALUES (#{popId}, #{userId}, NOW())
    </insert>

    <!--
        8) 팝업 단건 상세 조회
    -->
    <select id="selectPopupDetail" resultMap="PopupStoreResultMap">
        SELECT
        pop_id, pop_owner_id, pop_name, pop_description,
        pop_thumbnail, pop_location, pop_latitude, pop_longitude,
        pop_start_date, pop_end_date,
        pop_is_reservation, pop_price_type, pop_price, pop_status,
        pop_insta_url, pop_moderation_status, pop_is_deleted,
        pop_view_count, pop_ai_summary
        FROM POPUPSTORE
        WHERE pop_id = #{popId}
        AND pop_is_deleted = FALSE
    </select>

    <!--
        9) 팝업 상세 이미지 리스트 조회
    -->
    <select id="selectPopupImages" resultType="string">
        SELECT pi_url
        FROM POPUP_IMG
        WHERE pop_id = #{popId}
        ORDER BY pi_order ASC
    </select>

    <!--
        10) 팝업 해시태그 리스트 조회
    -->
    <select id="selectPopupHashtags" resultType="string">
        SELECT h.hash_name
        FROM HASHTAG h
        JOIN POPUP_HASHTAG ph ON h.hash_id = ph.hash_id
        WHERE ph.pop_id = #{popId}
        ORDER BY h.hash_name ASC
    </select>

    <!--
        11) 팝업 예약 시작 시간 조회
    -->
    <select id="selectReservationStartTime" resultType="java.time.LocalDateTime">
        SELECT pr_start_time
        FROM POPUP_RESERVATION
        WHERE pop_id = #{popId}
    </select>

    <select id="selectReservationEndTime" resultType="java.time.LocalDateTime">
        SELECT pr_end_time
        FROM POPUP_RESERVATION
        WHERE pop_id = #{popId}
    </select>


    <!-- 팝업 AI 요약 업데이트 -->
    <update id="updatePopupAiSummary">
        UPDATE POPUPSTORE
        SET
        pop_ai_summary = #{summary},
        updated_at     = CURRENT_TIMESTAMP
        WHERE pop_id = #{popId}
        AND pop_is_deleted = FALSE
    </update>

    <!--
        [User Report] 1) 유저 팝업 이용 이벤트 조회

        - VIEW / WISHLIST / RESERVATION 을 UNION 해서 한 번에 가져온다.
        - POPUPSTORE와 조인해서 가격 타입, 위치 포함
        - POPUP_HASHTAG / HASHTAG 조인으로 해시태그를 GROUP_CONCAT
    -->
    <select id="selectUserPopupEvents"
            resultType="com.popspot.popupplatform.dto.user.report.UserPopupEventDto">

        SELECT
        e.pop_id               AS popId,
        e.event_type           AS eventType,
        e.event_at             AS eventAt,
        ps.pop_price_type      AS priceType,
        e.people_count         AS peopleCount,
        TRIM(SUBSTRING_INDEX(ps.pop_location, ' ', 2)) AS region,
        GROUP_CONCAT(DISTINCT h.hash_name
        ORDER BY h.hash_name SEPARATOR ',') AS hashtags
        FROM (
        -- 조회 기록
        SELECT
        pv.pop_id        AS pop_id,
        'VIEW'           AS event_type,
        pv.pv_viewed_at  AS event_at,
        NULL             AS people_count
        FROM POPUP_VIEWED pv
        WHERE pv.user_id = #{userId}

        UNION ALL

        -- 찜 기록
        SELECT
        uw.pop_id        AS pop_id,
        'WISHLIST'       AS event_type,
        uw.created_at    AS event_at,
        NULL             AS people_count
        FROM USER_WISHLIST uw
        WHERE uw.user_id = #{userId}

        UNION ALL

        -- 예약 기록
        SELECT
        ur.pop_id        AS pop_id,
        'RESERVATION'    AS event_type,
        ur.ur_date_time  AS event_at,
        ur.ur_user_cnt   AS people_count
        FROM USER_RESERVATION ur
        WHERE ur.user_id = #{userId}
        ) e
        JOIN POPUPSTORE ps
        ON ps.pop_id = e.pop_id
        LEFT JOIN POPUP_HASHTAG ph
        ON ph.pop_id = ps.pop_id
        LEFT JOIN HASHTAG h
        ON h.hash_id = ph.hash_id
        GROUP BY
        e.pop_id,
        e.event_type,
        e.event_at,
        e.people_count,
        ps.pop_price_type,
        ps.pop_location
        ORDER BY
        e.event_at DESC
    </select>

    <!--
    [User Report] 2) 나와 비슷한 성향의 사람들이 찾는 팝업 추천

    아이디어:
    - 사용자가 찜한 팝업에 달린 해시태그들을 기준으로
    - 그 해시태그들을 가진 다른 팝업들을 추출
    - ENDED 아닌 팝업만, 해시태그 겹치는 수 + 조회수(pop_view_count) 기준 정렬
    - 사용자가 이미 본/찜/예약한 팝업은 제외 (원하면 제외 안 해도 됨)
    -->
    <select id="selectSimilarTastePopups"
            resultType="com.popspot.popupplatform.dto.user.report.UserPersonaPopupCard">

        SELECT
        ps.pop_id          AS popId,
        ps.pop_thumbnail   AS thumbnailUrl,
        ps.pop_name        AS title,
        ps.pop_location    AS location,
        ps.pop_price       AS price,
        ps.pop_price_type  AS priceType,
        ps.pop_status      AS status
        FROM POPUPSTORE ps
        JOIN POPUP_HASHTAG ph
        ON ph.pop_id = ps.pop_id
        WHERE ph.hash_id IN (
        -- 사용자가 찜한 팝업들의 해시태그 목록
        SELECT DISTINCT ph2.hash_id
        FROM USER_WISHLIST uw
        JOIN POPUP_HASHTAG ph2
        ON ph2.pop_id = uw.pop_id
        WHERE uw.user_id = #{userId}
        )
        AND ps.pop_status != 'ENDED'
        AND ps.pop_is_deleted = FALSE
        AND ps.pop_id NOT IN (
        -- 사용자가 이미 본/찜/예약한 팝업은 제외 (추천 신선도 확보)
        SELECT pop_id
        FROM USER_WISHLIST
        WHERE user_id = #{userId}
        UNION
        SELECT pop_id
        FROM POPUP_VIEWED
        WHERE user_id = #{userId}
        UNION
        SELECT pop_id
        FROM USER_RESERVATION
        WHERE user_id = #{userId}
        )
        GROUP BY
        ps.pop_id,
        ps.pop_thumbnail,
        ps.pop_name,
        ps.pop_location,
        ps.pop_price,
        ps.pop_price_type,
        ps.pop_status,
        ps.pop_view_count
        ORDER BY
        COUNT(DISTINCT ph.hash_id) DESC,    -- 나와 해시태그가 많이 겹칠수록 우선
        ps.pop_view_count DESC,             -- 많이 보는 팝업일수록 우선
        ps.created_at DESC
        LIMIT #{limit}
    </select>

    <!--
       [User Report] 3) 같은 성별 + 연령대에서 인기 있는 팝업

       - POPUP_VIEWED / USER_WISHLIST / USER_RESERVATION 을 모두 이벤트로 보고
       - user_gender, user_birthyear 로 필터링
       - ENDED 아닌 팝업만 추천
   -->
    <select id="selectDemographicPopularPopups"
            resultType="com.popspot.popupplatform.dto.user.report.UserPersonaPopupCard">

        SELECT
        ps.pop_id          AS popId,
        ps.pop_thumbnail   AS thumbnailUrl,
        ps.pop_name        AS title,
        ps.pop_location    AS location,
        ps.pop_price       AS price,
        ps.pop_price_type  AS priceType,
        ps.pop_status      AS status
        FROM POPUPSTORE ps
        JOIN (
        SELECT
        e.pop_id    AS pop_id,
        COUNT(*)    AS score
        FROM (
        -- 조회
        SELECT
        pv.pop_id         AS pop_id,
        u.user_gender     AS user_gender,
        u.user_birthyear  AS user_birthyear
        FROM POPUP_VIEWED pv
        JOIN USER u
        ON u.user_id = pv.user_id

        UNION ALL

        -- 찜
        SELECT
        uw.pop_id         AS pop_id,
        u.user_gender     AS user_gender,
        u.user_birthyear  AS user_birthyear
        FROM USER_WISHLIST uw
        JOIN USER u
        ON u.user_id = uw.user_id

        UNION ALL

        -- 예약
        SELECT
        ur.pop_id         AS pop_id,
        u.user_gender     AS user_gender,
        u.user_birthyear  AS user_birthyear
        FROM USER_RESERVATION ur
        JOIN USER u
        ON u.user_id = ur.user_id
        ) e
        WHERE e.user_gender = #{gender}
        AND e.user_birthyear BETWEEN #{birthYearStart} AND #{birthYearEnd}
        GROUP BY e.pop_id
        ) t
        ON t.pop_id = ps.pop_id
        WHERE ps.pop_status != 'ENDED'
        AND ps.pop_is_deleted = FALSE
        ORDER BY
        t.score DESC,            -- 해당 성별/연령대에서 이벤트 많이 발생한 순
        ps.pop_view_count DESC,  -- 전체 조회수 서포트
        ps.created_at DESC
        LIMIT #{limit}
    </select>


    <!--
        [내 주변 팝업 조회]
        - 위/경도가 NOT NULL 인 팝업만 대상
        - 삭제되지 않은 팝업 + ENDED 아닌 팝업만
        - Haversine 공식을 이용해 거리 계산 (km)
    -->
    <select id="selectNearbyPopups"
            resultType="com.popspot.popupplatform.dto.popup.response.PopupNearbyItemResponse">

        SELECT
        ps.pop_id          AS popId,
        ps.pop_name        AS popName,
        ps.pop_thumbnail   AS popThumbnail,
        ps.pop_location    AS popLocation,
        ps.pop_latitude    AS popLatitude,
        ps.pop_longitude   AS popLongitude,
        ps.pop_price_type  AS popPriceType,
        ps.pop_price       AS popPrice,
        ps.pop_status      AS popStatus,

        -- 거리(km)
        (
        6371 * ACOS(
        COS(RADIANS(#{latitude}))
        * COS(RADIANS(ps.pop_latitude))
        * COS(RADIANS(ps.pop_longitude) - RADIANS(#{longitude}))
        + SIN(RADIANS(#{latitude})) * SIN(RADIANS(ps.pop_latitude))
        )
        ) AS distanceKm

        FROM POPUPSTORE ps
        WHERE
        ps.pop_is_deleted = FALSE
        AND ps.pop_status != 'ENDED'
        AND ps.pop_latitude IS NOT NULL
        AND ps.pop_longitude IS NOT NULL

        <if test="radiusKm != null">
            AND (
            6371 * ACOS(
            COS(RADIANS(#{latitude}))
            * COS(RADIANS(ps.pop_latitude))
            * COS(RADIANS(ps.pop_longitude) - RADIANS(#{longitude}))
            + SIN(RADIANS(#{latitude})) * SIN(RADIANS(ps.pop_latitude))
            )
            ) &lt;= #{radiusKm}
        </if>

        ORDER BY
        distanceKm ASC,
        ps.pop_id DESC

        LIMIT #{limit}
    </select>

    <select id="selectPriceByPopId" resultType="int">
        SELECT pop_price
        FROM POPUPSTORE
        WHERE pop_id = #{popId}
    </select>

</mapper>
