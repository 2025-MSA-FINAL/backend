<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.popspot.popupplatform.mapper.main.MainRecommendMapper">

    <!-- =========================================================
         1) 비로그인: 인기 추천
         기준: 조회수 + 찜 수
         ========================================================= -->
    <select id="selectPopularPopups"
            resultType="com.popspot.popupplatform.dto.main.MainRecommendPopupDto">
        SELECT
        p.pop_id            AS popId,
        p.pop_name          AS popName,
        p.pop_thumbnail     AS popThumbnail,
        p.pop_location      AS popLocation,
        p.pop_start_date    AS popStartDate,
        p.pop_end_date      AS popEndDate,
        p.pop_price_type    AS popPriceType
        FROM POPUPSTORE p
        LEFT JOIN USER_WISHLIST uw
        ON p.pop_id = uw.pop_id
        WHERE p.pop_is_deleted = FALSE
        AND p.pop_moderation_status = TRUE
        AND p.pop_status != 'ENDED'
        GROUP BY p.pop_id
        ORDER BY
        (
        IFNULL(p.pop_view_count, 0) * 1.0
        + COUNT(uw.user_id) * 3.0
        ) DESC,
        p.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- =========================================================
         2) 로그인: 유저 취향 프로필
         - 최근 본 팝업 이름
         - 선호 해시태그 TOP
         - 무료/유료 선호
         ========================================================= -->
    <select id="selectUserTasteProfile"
            resultType="com.popspot.popupplatform.dto.main.UserTasteProfileDto">

        SELECT
        /* 최근 본 팝업 이름 (최대 5개) */
        (
        SELECT GROUP_CONCAT(ps.pop_name ORDER BY pv.pv_viewed_at DESC)
        FROM POPUP_VIEWED pv
        JOIN POPUPSTORE ps ON pv.pop_id = ps.pop_id
        WHERE pv.user_id = #{userId}
        LIMIT 5
        ) AS recentViewedNames,

        /* 선호 태그 TOP 5 */
        (
        SELECT GROUP_CONCAT(h.hash_name ORDER BY cnt DESC)
        FROM (
        SELECT ph.hash_id, COUNT(*) cnt
        FROM POPUP_VIEWED pv
        JOIN POPUP_HASHTAG ph ON pv.pop_id = ph.pop_id
        WHERE pv.user_id = #{userId}
        GROUP BY ph.hash_id
        ORDER BY cnt DESC
        LIMIT 5
        ) t
        JOIN HASHTAG h ON t.hash_id = h.hash_id
        ) AS topTags,

        /* 무료/유료 선호 */
        (
        SELECT
        CASE
        WHEN SUM(ps.pop_price_type = 'FREE') >= SUM(ps.pop_price_type != 'FREE')
        THEN 'FREE'
        ELSE 'PAID'
        END
        FROM POPUP_VIEWED pv
        JOIN POPUPSTORE ps ON pv.pop_id = ps.pop_id
        WHERE pv.user_id = #{userId}
        ) AS pricePreference
    </select>

    <!-- =========================================================
         3) 로그인: AI 후보군 (최대 N개)
         - 유저가 본/찜한 태그 기반
         ========================================================= -->
    <select id="selectAiCandidates"
            resultType="com.popspot.popupplatform.dto.main.MainRecommendPopupDto">

        SELECT DISTINCT
        p.pop_id            AS popId,
        p.pop_name          AS popName,
        p.pop_thumbnail     AS popThumbnail,
        p.pop_location      AS popLocation,
        p.pop_start_date    AS popStartDate,
        p.pop_end_date      AS popEndDate,
        p.pop_price_type    AS popPriceType
        FROM POPUPSTORE p
        JOIN POPUP_HASHTAG ph
        ON p.pop_id = ph.pop_id
        WHERE p.pop_is_deleted = FALSE
        AND p.pop_moderation_status = TRUE
        AND p.pop_status != 'ENDED'
        AND ph.hash_id IN (
        SELECT DISTINCT ph2.hash_id
        FROM POPUP_VIEWED pv
        JOIN POPUP_HASHTAG ph2
        ON pv.pop_id = ph2.pop_id
        WHERE pv.user_id = #{userId}
        )
        ORDER BY p.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- =========================================================
         4) AI 결과 popId 순서 유지 조회
         ========================================================= -->
    <select id="selectPopupsByIdsInOrder"
            resultType="com.popspot.popupplatform.dto.main.MainRecommendPopupDto">
        SELECT
        p.pop_id            AS popId,
        p.pop_name          AS popName,
        p.pop_thumbnail     AS popThumbnail,
        p.pop_location      AS popLocation,
        p.pop_start_date    AS popStartDate,
        p.pop_end_date      AS popEndDate,
        p.pop_price_type    AS popPriceType
        FROM POPUPSTORE p
        WHERE p.pop_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY FIELD(
        p.pop_id,
        <foreach collection="ids" item="id" separator=",">
            #{id}
        </foreach>
        )
    </select>

</mapper>
