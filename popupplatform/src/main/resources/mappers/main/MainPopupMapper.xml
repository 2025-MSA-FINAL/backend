<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.popspot.popupplatform.mapper.main.MainPopupMapper">


    <resultMap id="MainPopupCardMap" type="com.popspot.popupplatform.dto.main.MainPopupCardDto">
        <id     property="popId"        column="pop_id"/>
        <result property="popName"      column="pop_name"/>
        <result property="popThumbnail" column="pop_thumbnail"/>
        <result property="popLocation"  column="pop_location"/>
        <result property="popStartDate" column="pop_start_date"/>
        <result property="popEndDate"   column="pop_end_date"/>
        <result property="popPriceType" column="pop_price_type"/>
    </resultMap>
    <!-- 최근 생성된 팝업 n개 -->
    <select id="selectLatestPopups"   resultMap="MainPopupCardMap">
        SELECT
        p.pop_id,
        p.pop_name,
        p.pop_thumbnail,
        p.pop_location,
        p.pop_start_date,
        p.pop_end_date,
        p.pop_price_type
        FROM POPUPSTORE p
        WHERE p.pop_is_deleted = FALSE
        AND p.pop_moderation_status = TRUE
        AND p.pop_status != 'ENDED'
        ORDER BY p.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 종료 임박 팝업 n개 -->
    <select id="selectEndingSoonPopups"  resultMap="MainPopupCardMap">
        SELECT
        p.pop_id,
        p.pop_name,
        p.pop_thumbnail,
        p.pop_location,
        p.pop_start_date,
        p.pop_end_date,
        p.pop_price_type
        FROM POPUPSTORE p
        WHERE p.pop_is_deleted = FALSE
        AND p.pop_moderation_status = TRUE
        AND p.pop_status != 'ENDED'
        AND p.pop_end_date >= NOW()
        ORDER BY p.pop_end_date ASC, p.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 메인 HERO: 조회수 TOP n -->
    <select id="selectTopViewedPopups" resultMap="MainPopupCardMap">
        SELECT
        p.pop_id,
        p.pop_name,
        p.pop_thumbnail,
        p.pop_location,
        p.pop_start_date,
        p.pop_end_date,
        p.pop_price_type
        FROM POPUPSTORE p
        WHERE p.pop_is_deleted = FALSE
        AND p.pop_moderation_status = TRUE
        AND p.pop_status != 'ENDED'
        AND p.pop_end_date >= NOW()
        AND p.pop_view_count > 0
        ORDER BY p.pop_view_count DESC
        LIMIT #{limit}
    </select>

    <!-- ✅ NEW: 두근두근 곧 오픈예정 (오늘 기준 1달 이내, 시작일 빠른 순) -->
    <select id="selectOpeningSoonPopups" resultMap="MainPopupCardMap">
        SELECT
        p.pop_id,
        p.pop_name,
        p.pop_thumbnail,
        p.pop_location,
        p.pop_start_date,
        p.pop_end_date,
        p.pop_price_type
        FROM POPUPSTORE p
        WHERE p.pop_is_deleted = FALSE
        AND p.pop_moderation_status = TRUE
        AND p.pop_status != 'ENDED'
        -- 오늘 이후(오늘 포함 오픈도 포함시키려면 >= NOW() 대신 >= CURDATE())
        AND p.pop_start_date >= NOW()
        AND p.pop_end_date &lt; DATE_ADD(NOW(), INTERVAL 1 MONTH)
        ORDER BY p.pop_start_date ASC, p.created_at DESC
        LIMIT #{limit}
    </select>


</mapper>
